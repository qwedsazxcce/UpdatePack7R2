name: 下载Win7文件并指定完整名上传到Releases

on:
  workflow_dispatch:  # 手动触发

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # 步骤1：检出仓库（上传必需）
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：下载所有文件（修正链接+保留完整原名）
      - name: 下载所有Win7相关文件（修正链接）
        run: |
          # 定义修正后的8个下载链接（重点：x64企业版路径改为Windows7x64）
          declare -A FILES=(
            ["install_Windows7x86ULTIMATE.7z.001"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ULTIMATE.7z.001"
            ["install_Windows7x86ULTIMATE.7z.002"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ULTIMATE.7z.002"
            ["install_Windows7x64ULTIMATE.7z.001"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ULTIMATE.7z.001"
            ["install_Windows7x64ULTIMATE.7z.002"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ULTIMATE.7z.002"
            ["install_Windows7x86ENTERPRISE.7z.001"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ENTERPRISE.7z.001"
            ["install_Windows7x86ENTERPRISE.7z.002"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ENTERPRISE.7z.002"
            ["install_Windows7x64ENTERPRISE.7z.001"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ENTERPRISE.7z.001"
            ["install_Windows7x64ENTERPRISE.7z.002"]="https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ENTERPRISE.7z.002"
          )

          # 遍历下载（文件名+链接一一对应）
          for filename in "${!FILES[@]}"; do
            url="${FILES[$filename]}"
            echo "=== 开始下载：$filename ==="
            
            # 带详细日志的下载命令
            curl -v -L -o "$filename" \
              --retry 8 \
              --retry-delay 10 \
              --max-time 300 \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              "$url"

            # 严格校验文件
            if [ -f "$filename" ] && [ -s "$filename" ]; then
              echo "✅ $filename 下载成功，大小：$(du -h "$filename" | awk '{print $1}')"
            else
              echo "❌ $filename 下载失败（文件不存在或为空）！"
              exit 1
            fi
          done

          # 关键：打印当前目录所有文件，确认下载成功（调试用）
          echo "=== 下载完成后，当前目录文件列表 ==="
          ls -l

      # 步骤3：上传（直接指定所有完整文件名，无通配符）
      - name: 上传文件到Win7_SP1_Ult_Ent Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Win7_SP1_Ult_Ent
          overwrite: true
          # 逐个列出所有完整文件名，无注释、无通配符
          files: |
            install_Windows7x86ULTIMATE.7z.001
            install_Windows7x86ULTIMATE.7z.002
            install_Windows7x64ULTIMATE.7z.001
            install_Windows7x64ULTIMATE.7z.002
            install_Windows7x86ENTERPRISE.7z.001
            install_Windows7x86ENTERPRISE.7z.002
            install_Windows7x64ENTERPRISE.7z.001
            install_Windows7x64ENTERPRISE.7z.002
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 步骤4：完成确认
      - name: 全流程完成提示
        run: |
          echo "✅ 所有文件已成功上传！"
          echo "=== 最终上传文件列表 ==="
          ls -l *.7z.*
