name: Test Upload Function

on:
  workflow_dispatch:
    inputs:
      repo_owner:
        description: 'Repository Owner (默认自动检测)'
        required: false
        default: ''
      repo_name:
        description: 'Repository Name (默认自动检测)'
        required: false
        default: ''

env:
  # 测试文件下载URL
  TEST_FILE_1_URL: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install-26.1.15/EasyRCV3.V3.8_.7z
  TEST_FILE_2_URL: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install-26.1.15/OpenCode.Desktop.Installer.exe
  
  # 目标文件名（与原始YAML保持一致）
  TARGET_FILE_1: Windows7_ULT&ENT_32&64.7z.001
  TARGET_FILE_2: Windows7_ULT&ENT_32&64.7z.002
  
  # Release相关信息
  RELEASE_TAG: Windows7_ULT&ENT_32&64
  RELEASE_NAME: Windows7_ULT&ENT_32&64

jobs:
  test-upload:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell
      run: |
        # 确保使用最新版本的PowerShell
        $PSVersionTable.PSVersion
        
    - name: Create working directory
      run: |
        mkdir workdir
        cd workdir
        
    - name: Download test file 1
      run: |
        cd workdir
        Write-Host "Downloading: ${{ env.TEST_FILE_1_URL }}"
        curl -L -o "${{ env.TARGET_FILE_1 }}" "${{ env.TEST_FILE_1_URL }}"
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to download test file 1"
        }
        Write-Host "Download completed: ${{ env.TARGET_FILE_1 }}"
        
    - name: Download test file 2
      run: |
        cd workdir
        Write-Host "Downloading: ${{ env.TEST_FILE_2_URL }}"
        curl -L -o "${{ env.TARGET_FILE_2 }}" "${{ env.TEST_FILE_2_URL }}"
        if ($LASTEXITCODE -ne 0) {
            throw "Failed to download test file 2"
        }
        Write-Host "Download completed: ${{ env.TARGET_FILE_2 }}"
        
    - name: Verify downloaded files
      run: |
        cd workdir
        $files = @("${{ env.TARGET_FILE_1 }}", "${{ env.TARGET_FILE_2 }}")
        foreach ($file in $files) {
            if (Test-Path $file) {
                $size = (Get-Item $file).Length
                Write-Host "✓ $file ($([math]::Round($size / 1MB, 2)) MB)"
            } else {
                throw "File not found: $file"
            }
        }
        
    - name: Get repository information
      id: repo_info
      run: |
        # 自动检测仓库信息
        $repoUrl = git remote get-url origin
        Write-Host "Repository URL: $repoUrl"
        
        $owner = $null
        $name = $null
        
        # 处理不同的URL格式
        if ($repoUrl -match "github\.com[:/]([^/]+)/(.+?)(\.git)?$" -or 
            $repoUrl -match "github\.com/([^/]+)/(.+?)$" -or
            $repoUrl -match "https://github\.com/([^/]+)/(.+?)(\.git)?$" -or
            $repoUrl -match "git@github\.com:([^/]+)/(.+?)(\.git)?$" -or
            $repoUrl -match "ssh://git@github\.com/([^/]+)/(.+?)(\.git)?$" -or
            $repoUrl -match "github\.com\\(.+?)\\(.+?)(\.git)?$") {
            
            $owner = $matches[1]
            $name = $matches[2]
            
            # 清理可能的.git后缀
            if ($name -like "*.git") {
                $name = $name -replace "\.git$", ""
            }
            
            Write-Host "Detected owner: $owner"
            Write-Host "Detected name: $name"
        }
        
        # 如果自动检测失败，使用输入参数
        if ([string]::IsNullOrEmpty($owner) -or [string]::IsNullOrEmpty($name)) {
            Write-Host "Auto-detection failed, trying manual input..."
            if ("${{ github.event.inputs.repo_owner }}" -ne "") {
                $owner = "${{ github.event.inputs.repo_owner }}"
                Write-Host "Using specified owner: $owner"
            }
            if ("${{ github.event.inputs.repo_name }}" -ne "") {
                $name = "${{ github.event.inputs.repo_name }}"
                Write-Host "Using specified name: $name"
            }
        }
        
        # 最后的验证
        if ([string]::IsNullOrEmpty($owner) -or [string]::IsNullOrEmpty($name)) {
            Write-Error "Could not determine repository information"
            Write-Error "Repository URL: $repoUrl"
            Write-Error "Manual inputs - Owner: '${{ github.event.inputs.repo_owner }}', Name: '${{ github.event.inputs.repo_name }}'"
            throw "Repository information detection failed"
        }
        
        echo "repo_owner=$owner" >> $env:GITHUB_OUTPUT
        echo "repo_name=$name" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Delete existing release completely
      run: |
        $repoOwner = "${{ steps.repo_info.outputs.repo_owner }}"
        $repoName = "${{ steps.repo_info.outputs.repo_name }}"
        $token = "${{ secrets.GITHUB_TOKEN }}"
        
        Write-Host "Repository: $repoOwner/$repoName"
        Write-Host "Release tag: ${{ env.RELEASE_TAG }}"
        
        # Get release information
        try {
            $releaseInfo = Invoke-RestMethod -Uri "https://api.github.com/repos/$repoOwner/$repoName/releases/tags/${{ env.RELEASE_TAG }}" -Headers @{
                Authorization = "Bearer $token"
            }
            Write-Host "Found existing release with ID: $($releaseInfo.id)"
            
            # Delete the entire release
            Write-Host "Deleting entire release..."
            try {
                Invoke-RestMethod -Method Delete -Uri "https://api.github.com/repos/$repoOwner/$repoName/releases/$($releaseInfo.id)" -Headers @{
                    Authorization = "Bearer $token"
                }
                Write-Host "Successfully deleted release: ${{ env.RELEASE_TAG }}"
            } catch {
                Write-Warning "Could not delete release: $($_.Exception.Message)"
            }
        } catch {
            Write-Host "Release not found, will create new one"
        }
        
        # Wait a moment to ensure deletion is complete
        Start-Sleep -Seconds 3
      shell: pwsh
      continue-on-error: true
      
    - name: Prepare release assets list
      run: |
        cd workdir
        # 明确指定要上传的文件名，确保与环境变量一致
        $files = @(
          "workdir/${{ env.TARGET_FILE_1 }}",
          "workdir/${{ env.TARGET_FILE_2 }}"
        )
        
        # 验证文件是否存在
        $validFiles = @()
        foreach ($file in $files) {
          $actualPath = $file -replace "workdir/", ""
          if (Test-Path $actualPath) {
            $validFiles += $file
            Write-Host "✓ Found file: $actualPath"
          } else {
            Write-Warning "✗ File not found: $actualPath"
          }
        }
        
        if ($validFiles.Count -gt 0) {
            $filesList = $validFiles -join "`n"
            Write-Host "Files to upload:"
            Write-Host $filesList
            echo "FILES_LIST<<EOF" >> $env:GITHUB_ENV
            echo "$filesList" >> $env:GITHUB_ENV
            echo "EOF" >> $env:GITHUB_ENV
        } else {
            Write-Error "No valid files found for upload!"
            Get-ChildItem -Path . | ForEach-Object { Write-Host "Available files: $($_.Name)" }
            exit 1
        }
      shell: pwsh
      
    - name: Create or update release with assets
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.RELEASE_NAME }}
        tag_name: ${{ env.RELEASE_TAG }}
        draft: false
        prerelease: false
        generate_release_notes: false
        fail_on_unmatched_files: false
        files: |
          ${{ env.FILES_LIST }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify upload success
      run: |
        $repoOwner = "${{ steps.repo_info.outputs.repo_owner }}"
        $repoName = "${{ steps.repo_info.outputs.repo_name }}"
        $token = "${{ secrets.GITHUB_TOKEN }}"
        
        # Get final release information
        try {
            $releaseInfo = Invoke-RestMethod -Uri "https://api.github.com/repos/$repoOwner/$repoName/releases/tags/${{ env.RELEASE_TAG }}" -Headers @{
                Authorization = "Bearer $token"
            }
            
            Write-Host "Release verification:"
            Write-Host "Release name: $($releaseInfo.name)"
            Write-Host "Release tag: $($releaseInfo.tag_name)"
            Write-Host "Assets count: $($releaseInfo.assets.Count)"
            
            $uploadedAssets = $releaseInfo.assets | Where-Object { $_.name -match "Windows7_ULT&ENT_32&64.7z." }
            if ($uploadedAssets.Count -gt 0) {
                Write-Host "Successfully uploaded files:"
                foreach ($asset in $uploadedAssets) {
                    Write-Host "  - $($asset.name) ($([math]::Round($asset.size / 1MB, 2)) MB)"
                }
            } else {
                Write-Warning "No matching assets found in release"
            }
        } catch {
            Write-Error "Failed to verify upload: $($_.Exception.Message)"
        }
      shell: pwsh
