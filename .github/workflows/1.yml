name: 分批次上传Win7文件到Releases（稳定版）

on:
  workflow_dispatch:  # 手动触发

jobs:
  download-and-upload:
    runs-on: windows-latest  # 换更稳定的Windows Runner
    timeout-minutes: 120     # 延长总超时到2小时
    steps:
      # 步骤1：检出仓库
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 步骤2：下载所有文件（修正链接+保留完整原名）
      - name: 下载所有Win7相关文件
        shell: pwsh  # Windows用PowerShell更稳定
        run: |
          # 定义修正后的8个下载链接
          $files = @{
            "install_Windows7x86ULTIMATE.7z.001" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ULTIMATE.7z.001"
            "install_Windows7x86ULTIMATE.7z.002" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ULTIMATE.7z.002"
            "install_Windows7x64ULTIMATE.7z.001" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ULTIMATE.7z.001"
            "install_Windows7x64ULTIMATE.7z.002" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ULTIMATE.7z.002"
            "install_Windows7x86ENTERPRISE.7z.001" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ENTERPRISE.7z.001"
            "install_Windows7x86ENTERPRISE.7z.002" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x86/install_Windows7x86ENTERPRISE.7z.002"
            "install_Windows7x64ENTERPRISE.7z.001" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ENTERPRISE.7z.001"
            "install_Windows7x64ENTERPRISE.7z.002" = "https://github.com/yuanpeirong/UpdatePack7R2/releases/download/Windows7x64/install_Windows7x64ENTERPRISE.7z.002"
          }

          # 遍历下载（Windows PowerShell语法）
          foreach ($filename in $files.Keys) {
            $url = $files[$filename]
            Write-Host "=== 开始下载：$filename ==="
            
            # Windows用Invoke-WebRequest下载（比curl更稳定）
            Invoke-WebRequest -Uri $url -OutFile $filename `
              -UserAgent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" `
              -MaximumRetryCount 8 `
              -RetryIntervalSec 10

            # 校验文件
            if (Test-Path $filename -PathType Leaf) {
              $size = (Get-Item $filename).Length / 1GB
              Write-Host "✅ $filename 下载成功，大小：$($size.ToString('0.00')) GB"
            } else {
              Write-Error "❌ $filename 下载失败！"
              exit 1
            }
          }

          # 打印文件列表确认
          Write-Host "=== 下载完成，当前目录文件 ==="
          Get-ChildItem *.7z.*

      # 步骤3：分批次上传（核心修复：避免并行上传过多）
      # 批次1：x86旗舰版
      - name: 上传批次1（x86旗舰版）
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Win7_SP1_Ult_Ent
          overwrite: true
          files: |
            install_Windows7x86ULTIMATE.7z.001
            install_Windows7x86ULTIMATE.7z.002
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RELEASE_UPLOAD_CONCURRENCY: 1  # 限制并发数为1

      # 批次2：x64旗舰版
      - name: 上传批次2（x64旗舰版）
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Win7_SP1_Ult_Ent
          overwrite: true
          files: |
            install_Windows7x64ULTIMATE.7z.001
            install_Windows7x64ULTIMATE.7z.002
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RELEASE_UPLOAD_CONCURRENCY: 1

      # 批次3：x86企业版
      - name: 上传批次3（x86企业版）
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Win7_SP1_Ult_Ent
          overwrite: true
          files: |
            install_Windows7x86ENTERPRISE.7z.001
            install_Windows7x86ENTERPRISE.7z.002
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RELEASE_UPLOAD_CONCURRENCY: 1

      # 批次4：x64企业版
      - name: 上传批次4（x64企业版）
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Win7_SP1_Ult_Ent
          overwrite: true
          files: |
            install_Windows7x64ENTERPRISE.7z.001
            install_Windows7x64ENTERPRISE.7z.002
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_RELEASE_UPLOAD_CONCURRENCY: 1

      # 步骤4：完成确认
      - name: 全流程完成提示
        shell: pwsh
        run: |
          Write-Host "✅ 所有文件已分批次上传完成！"
          Write-Host "=== 最终文件列表 ==="
          Get-ChildItem *.7z.*
