name: Windows_7_ULT&ENT_32&64
on: [workflow_dispatch]

env:
  # 下载地址
  install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
  install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
  install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
  install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
  install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
  install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
  install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
  install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
  install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
  install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
  install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
  install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
  # 全局配置
  MAIN_ESD_NAME: Windows_7_ULT&ENT_32&64.esd
  SPLIT_VOLUME_SIZE: 1950M
  RELEASE_TAG: Windows_7_ULT&ENT_32&64

jobs:
  process_and_upload:
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd  # 全程使用CMD，而非PowerShell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 初始化ESD文件
        run: |
          if exist "%MAIN_ESD_NAME%" del /f /q "%MAIN_ESD_NAME%"
          type nul > "%MAIN_ESD_NAME%"
          echo ESD文件初始化完成：%MAIN_ESD_NAME%

      - name: 核心流程（下载→解压→转换，CMD原生处理）
        run: |
          @echo off
          chcp 936 > nul 2>&1  # 强制设置CMD编码为GBK（ANSI）
          
          :: 定义版本列表（CMD批量处理）
          set "VERSIONS=Windows7x86ULTIMATE:5:3 Windows7x86ENTERPRISE:1:3 Windows7x64ULTIMATE:4:3 Windows7x64ENTERPRISE:1:3"
          
          :: 遍历所有版本
          for %%v in (%VERSIONS%) do (
            :: 拆分版本信息：名称:索引:分卷数
            for /f "tokens=1,2,3 delims=:" %%a in ("%%v") do (
              set "VER_NAME=%%a"
              set "ESD_INDEX=%%b"
              set "PART_COUNT=%%c"
            )
            setlocal enabledelayedexpansion
            
            echo.
            echo =====================================
            echo 处理：!VER_NAME!（索引：!ESD_INDEX!）
            echo =====================================
            
            :: 1. 下载分卷（带3次重试）
            echo 1. 下载!VER_NAME!分卷
            set "DOWNLOAD_SUCCESS=1"
            for /l %%i in (1,1,!PART_COUNT!) do (
              :: 补零生成分卷号（001/002/003）
              set "PART_NUM=00%%i"
              set "PART_NUM=!PART_NUM:~-3!"
              
              :: 获取下载URL
              set "URL=!install_!VER_NAME!_!PART_NUM!!"
              call set "URL=%%install_!VER_NAME!_!PART_NUM!%%"
              set "SAVE_PATH=!VER_NAME!.7z.!PART_NUM!"
              
              if "!URL!"=="" (
                echo 错误：!VER_NAME! 分卷%%i 的URL为空，跳过
                set "DOWNLOAD_SUCCESS=0"
                goto :NEXT_VER
              )
              
              :: 下载重试逻辑
              set "RETRY=0"
              :DOWNLOAD_RETRY
              set "RETRY_SUCCESS=0"
              if exist "!SAVE_PATH!" del /f /q "!SAVE_PATH!"
              curl.exe -L -o "!SAVE_PATH!" "!URL!" --connect-timeout 30 --max-time 300
              if !errorlevel! equ 0 (
                :: 校验文件大小（大于1KB）
                for %%f in ("!SAVE_PATH!") do if %%~zf gtr 1024 set "RETRY_SUCCESS=1"
              )
              
              if !RETRY_SUCCESS! equ 1 (
                for %%f in ("!SAVE_PATH!") do echo !VER_NAME! 分卷%%i 下载成功：%%~zf 字节
                goto :DOWNLOAD_NEXT
              ) else (
                set /a RETRY+=3
                echo 警告：!VER_NAME! 分卷%%i 下载失败，重试!RETRY!/3
                if !RETRY! lss 3 (
                  timeout /t 5 /nobreak > nul
                  goto :DOWNLOAD_RETRY
                ) else (
                  echo 错误：!VER_NAME! 分卷%%i 下载重试3次失败，跳过
                  set "DOWNLOAD_SUCCESS=0"
                  goto :NEXT_VER
                )
              )
              :DOWNLOAD_NEXT
            )
            
            if !DOWNLOAD_SUCCESS! equ 0 goto :NEXT_VER
            
            :: 2. 解压分卷
            echo 2. 解压!VER_NAME!
            set "EXTRACT_DIR=!VER_NAME!"
            if exist "!EXTRACT_DIR!" rmdir /s /q "!EXTRACT_DIR!"
            md "!EXTRACT_DIR!"
            7z.exe x "!VER_NAME!.7z.001" -o"!EXTRACT_DIR!" -y -bb0 > nul 2>&1
            if !errorlevel! neq 0 (
              echo 错误：!VER_NAME! 解压失败，跳过
              goto :CLEANUP_VER
            )
            
            :: 3. 查找WIM文件
            echo 3. 查找WIM文件
            set "WIM_PATH="
            for /r "!EXTRACT_DIR!" %%f in (*.wim) do (
              set "WIM_PATH=%%f"
              goto :FOUND_WIM
            )
            :FOUND_WIM
            if "!WIM_PATH!"=="" (
              echo 错误：!VER_NAME! 未找到WIM文件，跳过
              goto :CLEANUP_VER
            )
            for %%f in ("!WIM_PATH!") do echo 找到WIM：%%~ff（大小：%%~zf 字节）
            
            :: 4. 读取WIM信息（CMD原生解析ANSI输出，无编码转换）
            echo 4. 读取索引!ESD_INDEX!的WIM信息
            dism.exe /Get-WimInfo /WimFile:"!WIM_PATH!" /Index:!ESD_INDEX! > dism_temp.txt 2>&1
            if !errorlevel! neq 0 (
              echo 警告：读取WIM信息失败，继续转换流程
              goto :CONVERT_ESD
            )
            
            :: 解析WIM名称和描述（ANSI直接匹配，无乱码）
            for /f "tokens=2,* delims=:" %%a in ('findstr /i /c:"Name:" dism_temp.txt') do set "IMAGE_NAME=%%b"
            for /f "tokens=2,* delims=:" %%a in ('findstr /i /c:"Description:" dism_temp.txt') do set "IMAGE_DESC=%%b"
            set "IMAGE_NAME=!IMAGE_NAME: =!"
            set "IMAGE_DESC=!IMAGE_DESC: =!"
            if "!IMAGE_NAME!"=="" set "IMAGE_NAME=未知名称"
            if "!IMAGE_DESC!"=="" set "IMAGE_DESC=未知描述"
            echo 映像名称：!IMAGE_NAME!
            echo 映像描述：!IMAGE_DESC!
            del /f /q dism_temp.txt
            
            :CONVERT_ESD
            :: 5. WIM转ESD（追加模式）
            echo 5. 转换WIM到ESD
            dism.exe /Export-Image /SourceImageFile:"!WIM_PATH!" /SourceIndex:!ESD_INDEX! /DestinationImageFile:"%MAIN_ESD_NAME%" /Compress:recovery /CheckIntegrity /Append > nul 2>&1
            if !errorlevel! equ 0 (
              for %%f in ("%MAIN_ESD_NAME%") do echo ESD转换成功，当前大小：%%~zf 字节
            ) else (
              echo 错误：!VER_NAME! ESD转换失败，跳过
              goto :CLEANUP_VER
            )
            
            :CLEANUP_VER
            :: 6. 清理临时文件
            echo 6. 清理临时文件
            if exist "!EXTRACT_DIR!" rmdir /s /q "!EXTRACT_DIR!"
            del /f /q "!VER_NAME!.7z.*" > nul 2>&1
            
            :NEXT_VER
            endlocal
          )
          echo.
          echo 所有版本处理完成

      - name: 分卷压缩ESD
        run: |
          @echo off
          chcp 936 > nul 2>&1
          if not exist "%MAIN_ESD_NAME%" (
            echo 警告：ESD文件不存在，跳过分卷
            exit /b 0
          )
          echo 分卷压缩ESD到7z（大小：%SPLIT_VOLUME_SIZE%）
          7z.exe a "%MAIN_ESD_NAME%.7z" "%MAIN_ESD_NAME%" -v%SPLIT_VOLUME_SIZE% -y -mx=9 -bb0 > nul 2>&1
          if !errorlevel! equ 0 (
            dir "%MAIN_ESD_NAME%.7z.*" | find /c ".7z." > temp_count.txt
            set /p FILE_COUNT=<temp_count.txt
            echo 分卷成功，生成!FILE_COUNT!个文件
            del /f /q "%MAIN_ESD_NAME%"
            del /f /q temp_count.txt
          ) else (
            echo 错误：7z分卷失败
            exit /b 1
          )

      - name: 发布到GitHub Release
        run: |
          @echo off
          chcp 936 > nul 2>&1
          set "7Z_PREFIX=%MAIN_ESD_NAME%.7z"
          
          :: 检查分卷文件
          dir "!7Z_PREFIX!.*" > nul 2>&1
          if !errorlevel! neq 0 (
            echo 警告：无分卷文件，跳过发布
            exit /b 0
          )
          
          :: 删除旧Release
          gh release delete "%RELEASE_TAG%" -y > nul 2>&1
          
          :: 创建新Release
          for /f "tokens=*" %%a in ('powershell -Command "Get-Date -Format 'yyyy-MM-dd HH:mm:ss'"') do set "BUILD_TIME=%%a"
          gh release create "%RELEASE_TAG%" --title "%RELEASE_TAG%" --notes "Windows7 ESD构建时间：!BUILD_TIME!"
          
          :: 上传所有分卷文件
          for %%f in ("!7Z_PREFIX!.*") do (
            echo 上传文件：%%~nxf
            gh release upload "%RELEASE_TAG%" "%%~ff" --clobber > nul 2>&1
          )
          echo 所有文件上传完成：%RELEASE_TAG%
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 最终清理
        run: |
          @echo off
          chcp 936 > nul 2>&1
          echo 最终清理临时文件
          del /f /q *.7z.* > nul 2>&1
          del /f /q *.wim > nul 2>&1
          del /f /q "%MAIN_ESD_NAME%" > nul 2>&1
          for /d %%d in (Windows7*) do rmdir /s /q "%%d"
          echo 清理完成
