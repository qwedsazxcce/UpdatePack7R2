name: Windows_7_ULT&ENT_32&64

# 触发方式：手动触发（可根据需要添加push/tag等触发条件）
on:
  workflow_dispatch:

env:
  # 定义所有下载地址变量（保持你提供的地址不变）
  install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
  install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
  install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
  install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
  install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
  install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
  install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
  install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
  install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
  install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
  install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
  install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
  # 分卷大小：1950M 转换为字节（1950*1024*1024=2044692480）
  SPLIT_SIZE: 2044692480
  # 版本配置（循环用，避免重复代码）
  VERSION_CONFIG: |
    [
      {"Name":"Windows7x86ULTIMATE","ESDIndex":5,"Parts":3},
      {"Name":"Windows7x86ENTERPRISE","ESDIndex":1,"Parts":3},
      {"Name":"Windows7x64ULTIMATE","ESDIndex":4,"Parts":3},
      {"Name":"Windows7x64ENTERPRISE","ESDIndex":1,"Parts":3}
    ]

jobs:
  process_and_upload:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
        encoding: OEM  # 对应Windows ANSI编码

    steps:
      # ==============================================
      # 1. 检出代码（可选，若需操作仓库文件则保留）
      # ==============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==============================================
      # 2. 安装并认证GitHub CLI（gh）
      # ==============================================
      - name: Setup GitHub CLI
        run: |
          # 安装gh cli（windows-latest默认无，用winget安装系统自带包）
          winget install --id GitHub.cli --silent --accept-package-agreements --accept-source-agreements
          # 认证gh cli（使用Actions内置Token）
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================================
      # 3. 循环处理所有Windows7版本（核心流程）
      # ==============================================
      - name: Process all Windows7 versions
        run: |
          # 解析版本配置
          $versions = $env:VERSION_CONFIG | ConvertFrom-Json
          
          foreach ($ver in $versions) {
            $verName = $ver.Name
            $esdIndex = $ver.ESDIndex
            $partCount = $ver.Parts
            
            Write-Host "`n========== 开始处理 $verName (ESD索引: $esdIndex) =========="
            
            # ------------------------------
            # 子步骤1：下载分卷压缩包
            # ------------------------------
            Write-Host "`n[Step 1] 下载 $verName 分卷包..."
            for ($i=1; $i -le $partCount; $i++) {
              $partNum = "{0:D3}" -f $i  # 格式化为001/002/003
              $varKey = "install_${verName}_${partNum}"
              $downloadUrl = [Environment]::GetEnvironmentVariable($varKey)
              $savePath = "`"$verName.7z.$partNum`""  # 文件名加双引号
              
              if ($downloadUrl) {
                Write-Host "下载分卷 $i: $downloadUrl -> $savePath"
                & curl.exe -L -o $savePath $downloadUrl
                if ($LASTEXITCODE -ne 0) { throw "分卷 $i 下载失败" }
              } else {
                Write-Warning "分卷 $i 无下载地址，跳过"
              }
            }

            # ------------------------------
            # 子步骤2：解压分卷压缩包
            # ------------------------------
            Write-Host "`n[Step 2] 解压 $verName 分卷包..."
            $first7z = "`"$verName.7z.001`""
            if (Test-Path $first7z) {
              & 7z.exe x $first7z -o"`"$verName`"" -y  # 系统自带7z解压
              if ($LASTEXITCODE -ne 0) { throw "解压失败" }
            } else {
              throw "未找到解压入口文件: $first7z"
            }

            # ------------------------------
            # 子步骤3：查找WIM文件
            # ------------------------------
            Write-Host "`n[Step 3] 查找 $verName WIM文件..."
            $wimFile = Get-ChildItem -Path "`"$verName`"" -Filter *.wim -Recurse -ErrorAction Stop | Select-Object -First 1
            if (-not $wimFile) { throw "未找到WIM文件" }
            $wimPath = "`"$($wimFile.FullName)`""
            Write-Host "找到WIM文件: $wimPath"

            # ------------------------------
            # 子步骤4：WIM转换为指定索引的ESD
            # ------------------------------
            Write-Host "`n[Step 4] 转换WIM为ESD（索引: $esdIndex）..."
            $esdPath = "`"$verName.esd`""
            & dism /Export-Image /SourceImageFile:$wimPath /SourceIndex:$esdIndex /DestinationImageFile:$esdPath /Compress:recovery /CheckIntegrity
            if ($LASTEXITCODE -ne 0) { throw "WIM转ESD失败" }

            # ------------------------------
            # 子步骤5：删除临时文件（WIM/分卷包/解压目录）
            # ------------------------------
            Write-Host "`n[Step 5] 删除 $verName 临时文件..."
            # 删除WIM文件
            if (Test-Path $wimPath) { Remove-Item -Path $wimPath -Force }
            # 删除解压目录
            if (Test-Path "`"$verName`"") { Remove-Item -Path "`"$verName`"" -Recurse -Force }
            # 删除分卷压缩包
            Get-ChildItem -Path "`"$verName.7z.*`"" -ErrorAction SilentlyContinue | Remove-Item -Force

            # ------------------------------
            # 子步骤6：ESD文件分卷压缩（1950M/卷）
            # ------------------------------
            Write-Host "`n[Step 6] 分卷压缩ESD文件（1950M/卷）..."
            $esdRawPath = $esdPath -replace '"', ''  # 去掉双引号便于流操作
            $splitPrefix = "`"$verName.esd.part`""
            $chunkSize = [int64]$env:SPLIT_SIZE

            # 用.NET FileStream实现分卷（系统自带，无需额外工具）
            $inStream = [System.IO.File]::OpenRead($esdRawPath)
            $buffer = New-Object byte[] $chunkSize
            $partNum = 1

            while ($bytesRead = $inStream.Read($buffer, 0, $buffer.Length)) {
              $partFile = "$splitPrefix$partNum"
              $outStream = [System.IO.File]::OpenWrite($partFile)
              $outStream.Write($buffer, 0, $bytesRead)
              $outStream.Close()
              $partNum++
            }
            $inStream.Close()

            # 删除原始ESD文件
            if (Test-Path $esdPath) { Remove-Item -Path $esdPath -Force }

            Write-Host "========== $verName 处理完成 ==========`n"
          }

      # ==============================================
      # 4. 删除原有Release和Tag（带重试）
      # ==============================================
      - name: Delete existing Release/Tag
        run: |
          $releaseName = "Windows_7_ULT&ENT_32&64"
          $tagName = "Win7-ULT-ENT-32-64"
          $retryTimes = 10
          $retryInterval = 30

          # 删除Release（重试10次，间隔30秒）
          Write-Host "`n[Delete Release] 尝试删除原有Release: $releaseName"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              gh release delete $releaseName -y
              Write-Host "Release删除成功（第$i次尝试）"
              break
            } catch {
              Write-Warning "第$i次删除Release失败: $_"
              Start-Sleep -Seconds $retryInterval
            }
          }

          # 删除Tag（重试10次，间隔30秒）
          Write-Host "`n[Delete Tag] 尝试删除原有Tag: $tagName"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              git tag -d $tagName  # 删除本地Tag
              git push origin --delete $tagName  # 删除远程Tag
              Write-Host "Tag删除成功（第$i次尝试）"
              break
            } catch {
              Write-Warning "第$i次删除Tag失败: $_"
              Start-Sleep -Seconds $retryInterval
            }
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================================
      # 5. 上传新分卷ESD到Release（带重试）
      # ==============================================
      - name: Upload ESD parts to Release
        run: |
          $releaseName = "Windows_7_ULT&ENT_32&64"
          $tagName = "Win7-ULT-ENT-32-64"
          $retryTimes = 10
          $retryInterval = 30

          # 创建新Release（重试10次）
          Write-Host "`n[Create Release] 尝试创建新Release: $releaseName"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              gh release create $tagName --title "$releaseName" --notes "Windows7 ULT&ENT 32&64 ESD 分卷文件"
              Write-Host "Release创建成功（第$i次尝试）"
              break
            } catch {
              Write-Warning "第$i次创建Release失败: $_"
              Start-Sleep -Seconds $retryInterval
            }
          }

          # 上传所有ESD分卷文件（每个文件重试10次）
          Write-Host "`n[Upload Files] 开始上传ESD分卷文件..."
          $esdParts = Get-ChildItem -Path "*.esd.part*" -ErrorAction SilentlyContinue
          if ($esdParts.Count -eq 0) { throw "无ESD分卷文件可上传" }

          foreach ($file in $esdParts) {
            $filePath = "`"$($file.FullName)`""
            Write-Host "上传文件: $filePath"
            
            for ($i=1; $i -le $retryTimes; $i++) {
              try {
                gh release upload $tagName $filePath --clobber
                Write-Host "文件 $filePath 上传成功（第$i次尝试）"
                break
              } catch {
                Write-Warning "第$i次上传 $filePath 失败: $_"
                Start-Sleep -Seconds $retryInterval
              }
            }
          }

      # ==============================================
      # 6. 最终清理临时文件
      # ==============================================
      - name: Final cleanup
        run: |
          Write-Host "`n[Cleanup] 清理所有临时文件..."
          # 删除ESD分卷文件
          Get-ChildItem -Path "*.esd.part*" -ErrorAction SilentlyContinue | Remove-Item -Force
          # 兜底删除残留的7z/WIM文件
          Get-ChildItem -Path @("*.7z.*", "*.wim", "*.esd") -ErrorAction SilentlyContinue | Remove-Item -Force
          Write-Host "清理完成"
