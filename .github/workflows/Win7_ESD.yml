name: Windows_7_ULT&ENT_32&64

on:
  workflow_dispatch:

env:
  # 固定下载地址变量
  install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
  install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
  install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
  install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
  install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
  install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
  install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
  install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
  install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
  install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
  install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
  install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
  # 统一ESD文件名
  MAIN_ESD_NAME: Windows_7_ULT&ENT_32&64.esd
  # 7z分卷大小
  SPLIT_VOLUME_SIZE: 1950M
  # 版本处理配置
  VERSION_CONFIG: |
    [
      {"Name":"Windows7x86ULTIMATE","ESDIndex":5,"Parts":3},
      {"Name":"Windows7x86ENTERPRISE","ESDIndex":1,"Parts":3},
      {"Name":"Windows7x64ULTIMATE","ESDIndex":4,"Parts":3},
      {"Name":"Windows7x64ENTERPRISE","ESDIndex":1,"Parts":3}
    ]

jobs:
  process_and_upload:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    
    steps:
      # ==============================================
      # 1. 检出代码
      # ==============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==============================================
      # 2. 增强版编码配置
      # ==============================================
      - name: Critical encoding setup (Robust ANSI/UTF8)
        run: |
          try {
            $encodingProvider = [System.Text.CodePagesEncodingProvider]::Instance
            [System.Text.Encoding]::RegisterProvider($encodingProvider)
            Write-Host "CodePagesEncodingProvider注册成功"
          } catch {
            Write-Warning "编码提供器注册失败：$_"
          }
          
          try {
            $global:ANSI_ENCODING = [System.Text.Encoding]::GetEncoding(936)
            $global:UTF8_ENCODING = [System.Text.Encoding]::UTF8
          } catch {
            Write-Warning "ANSI编码(936)加载失败，降级为UTF8：$_"
            $global:ANSI_ENCODING = [System.Text.Encoding]::UTF8
            $global:UTF8_ENCODING = [System.Text.Encoding]::UTF8
          }
          
          [Console]::OutputEncoding = $global:UTF8_ENCODING
          [Console]::InputEncoding = $global:UTF8_ENCODING
          Write-Host "控制台编码已设为：$([Console]::OutputEncoding.EncodingName)"

      # ==============================================
      # 3. 安装GitHub CLI
      # ==============================================
      - name: Setup GitHub CLI
        run: |
          winget install --id GitHub.cli --silent --accept-package-agreements --accept-source-agreements
          Start-Sleep -Seconds 5
          $env:GH_TOKEN | gh auth login --with-token
          gh auth status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================================
      # 4. 初始化ESD文件
      # ==============================================
      - name: Initialize main ESD file
        run: |
          $mainESD = $env:MAIN_ESD_NAME
          Write-Host "初始化ESD文件：$mainESD"
          
          if (Test-Path $mainESD) { Remove-Item -Path $mainESD -Force }
          New-Item -Path $mainESD -ItemType File -Force | Out-Null
          Write-Host "ESD文件创建成功：$((Get-Item $mainESD).FullName)"

      # ==============================================
      # 5. 核心处理逻辑（终极修复）
      # ==============================================
      - name: Process all Windows7 versions
        run: |
          # 下载函数
          function Download-7zParts {
            param(
              [string]$VerName,
              [int]$PartCount
            )
            $allPartsDownloaded = $true
            Write-Host "`n开始下载$VerName分卷包（共$PartCount个）..."
            
            for ($i=1; $i -le $PartCount; $i++) {
              $partNum = "{0:D3}" -f $i
              $downloadUrl = [Environment]::GetEnvironmentVariable("install_${VerName}_${partNum}")
              $savePath = "$VerName.7z.$partNum"
              $retryCount = 3
              $retryInterval = 3
              $downloadOk = $false
              
              if (-not $downloadUrl) {
                Write-Error "   分卷 $i：URL为空"
                $allPartsDownloaded = $false
                continue
              }
              
              Write-Host "   分卷 $i："
              Write-Host "      - URL：$downloadUrl"
              Write-Host "      - 保存路径：$savePath"
              
              for ($retry=1; $retry -le $retryCount; $retry++) {
                try {
                  if (Test-Path $savePath) { Remove-Item -Path $savePath -Force }
                  
                  & curl.exe -L -o "$savePath" $downloadUrl
                  Start-Sleep -Seconds 1
                  
                  if ($LASTEXITCODE -eq 0 -and (Test-Path $savePath) -and ((Get-Item $savePath).Length -gt 0)) {
                    $fileSize = [math]::Round((Get-Item $savePath).Length / 1MB, 2)
                    Write-Host "      - 重试$retry：下载成功（$fileSize MB）"
                    $downloadOk = $true
                    break
                  } else {
                    throw "curl退出码：$LASTEXITCODE，文件大小：$((Get-Item $savePath -ErrorAction SilentlyContinue).Length) 字节"
                  }
                } catch {
                  Write-Warning "      - 重试$retry：下载失败：$_"
                  if ($retry -eq $retryCount) {
                    Write-Error "      - 分卷 $i：$retryCount 次重试失败"
                    $allPartsDownloaded = $false
                  } else {
                    Start-Sleep -Seconds $retryInterval
                  }
                }
              }
              
              if (-not $downloadOk) { break }
            }
            
            if ($allPartsDownloaded) {
              Write-Host "`n   $VerName分卷下载完成："
              Get-ChildItem -Path "$VerName.7z.*" | Select-Object Name, Length | Format-Table -AutoSize
            }
            
            return $allPartsDownloaded
          }

          # 主逻辑
          $versions = $env:VERSION_CONFIG | ConvertFrom-Json
          $mainESD = $env:MAIN_ESD_NAME
          
          Write-Host "当前工作目录：$PWD"
          Write-Host "初始文件列表："
          Get-ChildItem | Select-Object Name | Format-Table -AutoSize
          
          foreach ($ver in $versions) {
            $verName = $ver.Name
            $targetIndex = $ver.ESDIndex
            $partCount = $ver.Parts
            $unzipRetryCount = 1
            
            Write-Host "`n=================================================="
            Write-Host "处理版本：$verName (目标索引：$targetIndex)"
            Write-Host "=================================================="
            
            # 1. 下载分卷
            $downloadSuccess = Download-7zParts -VerName $verName -PartCount $partCount
            if (-not $downloadSuccess) { throw "$verName 分卷下载失败" }

            # 2. 解压分卷（绝对路径）
            Write-Host "`n步骤2：解压分卷包..."
            $first7z = "$verName.7z.001"
            $extractDir = "$verName"
            $first7z_Abs = (Resolve-Path $first7z).Path
            $extractDir_Abs = Join-Path (Resolve-Path .).Path $extractDir
            
            Write-Host "   解压文件：$first7z_Abs"
            Write-Host "   解压到：$extractDir_Abs"
            
            $unzipOk = $false
            for ($unzipRetry=0; $unzipRetry -le $unzipRetryCount; $unzipRetry++) {
              if ($unzipRetry -gt 0) {
                Write-Host "`n   解压失败，重试$unzipRetry：删除分卷并重新下载..."
                Get-ChildItem -Path "$verName.7z.*" | Remove-Item -Force
                $downloadSuccess = Download-7zParts -VerName $verName -PartCount $partCount
                if (-not $downloadSuccess) { throw "$verName 重新下载失败" }
                $first7z_Abs = (Resolve-Path $first7z).Path
              }

              & 7z.exe x "$first7z_Abs" -o"$extractDir_Abs" -y
              if ($LASTEXITCODE -eq 0) {
                Write-Host "   解压完成"
                $unzipOk = $true
                break
              } else {
                Write-Error "   解压失败（7z退出码：$LASTEXITCODE）"
              }
            }
            if (-not $unzipOk) { throw "$verName 解压失败（所有重试用尽）" }

            # 3. 读取WIM信息（核心修复：无引号路径+索引验证）
            Write-Host "`n步骤3：读取WIM文件信息..."
            $wimFiles = Get-ChildItem -Path $extractDir_Abs -Filter *.wim -Recurse
            if ($wimFiles.Count -eq 0) { throw "未找到WIM文件（目录：$extractDir_Abs）" }
            $wimPath = $wimFiles[0].FullName
            
            Write-Host "   WIM文件：$wimPath"
            Write-Host "   WIM大小：$([math]::Round($wimFiles[0].Length / 1GB, 2)) GB"
            
            # 修复1：先读取所有索引，验证目标索引是否存在（无引号路径）
            Write-Host "`n   读取WIM所有索引列表..."
            $indexListOutput = & dism /Get-WimInfo /WimFile:$wimPath 2>&1
            $indexListStr = $indexListOutput | Out-String
            
            # 提取所有索引编号
            $indexMatches = [regex]::Matches($indexListStr, 'Index\s*:\s*(\d+)')
            $validIndexes = $indexMatches.Groups[1].Value | Select-Object -Unique
            Write-Host "   WIM有效索引：$($validIndexes -join ", ")"
            
            if (-not $validIndexes.Contains($targetIndex.ToString())) {
              throw "目标索引$targetIndex不存在！WIM有效索引：$($validIndexes -join ", ")"
            }

            # 修复2：读取目标索引信息（无引号路径）
            Write-Host "`n   读取WIM索引$targetIndex的映像名..."
            $dismOutput = & dism /Get-WimInfo /WimFile:$wimPath /Index:$targetIndex 2>&1
            $dismStr = $dismOutput | Out-String
            
            # 提取映像名
            $imageNameMatch = [regex]::Match($dismStr, 'Image Name\s*:\s*(.+)')
            if ($imageNameMatch.Success) {
              $imageName = $imageNameMatch.Groups[1].Value.Trim()
              if ([string]::IsNullOrEmpty($imageName)) {
                throw "映像名提取为空"
              }
              Write-Host "   映像名：$imageName"
            } else {
              throw "未找到映像名（Image Name）`nDISM输出：$dismStr"
            }

            # 4. WIM转ESD
            Write-Host "`n步骤4：转换WIM索引$targetIndex为ESD..."
            & dism /Export-Image `
              /SourceImageFile:$wimPath `
              /SourceIndex:$targetIndex `
              /DestinationImageFile:$mainESD `
              /Compress:recovery `
              /CheckIntegrity `
              /Append
            
            if ($LASTEXITCODE -ne 0) { throw "WIM转ESD失败（DISM退出码：$LASTEXITCODE）" }
            Write-Host "   ESD转换成功（大小：$([math]::Round((Get-Item $mainESD).Length / 1GB, 2)) GB）"

            # 5. 清理临时文件
            Write-Host "`n步骤5：清理临时文件..."
            Remove-Item -Path $wimPath -Force -ErrorAction SilentlyContinue
            Remove-Item -Path $extractDir_Abs -Recurse -Force -ErrorAction SilentlyContinue
            Get-ChildItem -Path "$verName.7z.*" | Remove-Item -Force -ErrorAction SilentlyContinue
            Write-Host "   临时文件清理完成"

            Write-Host "`n=================================================="
            Write-Host "$verName 处理完成！"
            Write-Host "==================================================`n"
          }

      # ==============================================
      # 6. 分卷压缩ESD
      # ==============================================
      - name: Split ESD to 7z parts
        run: |
          $mainESD = $env:MAIN_ESD_NAME
          $splitSize = $env:SPLIT_VOLUME_SIZE
          $7zPrefix = "$mainESD.7z"
          
          Write-Host "`n分卷压缩ESD文件：$mainESD"
          Write-Host "分卷大小：$splitSize"
          
          if (-not (Test-Path $mainESD)) { throw "ESD文件不存在：$mainESD" }
          if ((Get-Item $mainESD).Length -eq 0) { throw "ESD文件为空" }
          
          & 7z.exe a "$7zPrefix" "$mainESD" -v$splitSize -y -mx=9
          if ($LASTEXITCODE -ne 0) { throw "7z分卷失败（退出码：$LASTEXITCODE）" }
          
          Remove-Item -Path $mainESD -Force
          $splitFiles = Get-ChildItem -Path "$7zPrefix.*"
          Write-Host "分卷完成，生成$($splitFiles.Count)个文件："
          $splitFiles | Select-Object Name, Length | Format-Table -AutoSize

      # ==============================================
      # 7. 发布Release
      # ==============================================
      - name: Publish Release
        run: |
          $releaseTag = "Windows_7_ULT&ENT_32&64"
          $7zPrefix = "$($env:MAIN_ESD_NAME).7z"
          $retryTimes = 10
          $retryInterval = 30

          # 删除旧Release/Tag
          Write-Host "`n删除旧Release/Tag：$releaseTag"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              gh release delete $releaseTag -y 2>&1 | Out-Null
              git tag -d $releaseTag 2>&1 | Out-Null
              git push origin --delete $releaseTag 2>&1 | Out-Null
              Write-Host "   删除成功（第$i次尝试）"
              break
            } catch {
              Write-Warning "   删除失败（第$i次尝试）：$_"
              Start-Sleep -Seconds $retryInterval
            }
          }

          # 创建新Release
          Write-Host "`n创建新Release：$releaseTag"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              gh release create $releaseTag `
                --title "$releaseTag" `
                --notes "Windows7 ULT&ENT 32&64 合并ESD（7z分卷$($env:SPLIT_VOLUME_SIZE)）"
              Write-Host "   创建成功（第$i次尝试）"
              break
            } catch {
              Write-Warning "   创建失败（第$i次尝试）：$_"
              Start-Sleep -Seconds $retryInterval
            }
          }

          # 上传分卷文件
          $splitFiles = Get-ChildItem -Path "$7zPrefix.*"
          Write-Host "`n上传$($splitFiles.Count)个分卷文件..."
          
          foreach ($file in $splitFiles) {
            $filePath = $file.FullName
            Write-Host "   上传：$($file.Name)"
            
            for ($i=1; $i -le $retryTimes; $i++) {
              try {
                gh release upload $releaseTag "$filePath" --clobber
                Write-Host "   - 上传成功（第$i次尝试）"
                break
              } catch {
                Write-Warning "   - 上传失败（第$i次尝试）：$_"
                Start-Sleep -Seconds $retryInterval
              }
            }
          }

      # ==============================================
      # 8. 最终清理
      # ==============================================
      - name: Final cleanup
        run: |
          Write-Host "`n最终清理临时文件..."
          $7zPrefix = "$($env:MAIN_ESD_NAME).7z"
          
          Get-ChildItem -Path @("*.7z.*", "*.wim", $env:MAIN_ESD_NAME) -ErrorAction SilentlyContinue | Remove-Item -Force
          Get-ChildItem -Path * -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "Windows7" } | Remove-Item -Recurse -Force
          
          Write-Host "清理完成！"
