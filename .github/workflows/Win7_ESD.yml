# GitHub Actions工作流：Windows7 WIM转ESD并上传Releases
name: Windows7_WIM2ESD
on:
  workflow_dispatch:  # 仅手动触发
jobs:
  build_win7_esd:
    runs-on: windows-2022
    timeout-minutes: 180
    steps:
      # 步骤1：检出仓库
      - name: Checkout repository
        uses: actions/checkout@v4
        if: always()  # 确保始终执行（仅为检出，不影响核心流程）

      # 步骤2：安装依赖（7-Zip + GitHub CLI）
      - name: Install 7-Zip and GitHub CLI
        id: install_deps  # 标记步骤ID，便于后续判断
        run: |
          # 强制设置执行策略
          Set-ExecutionPolicy Bypass -Scope Process -Force -ErrorAction Stop
          
          # 安装/校验Chocolatey
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
              Write-Host "安装Chocolatey..."
              [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
              iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1')) -ErrorAction Stop
          }

          # 安装7-Zip
          choco install 7zip --version=24.07 -y --no-progress --error-action Stop
          # 安装GitHub CLI
          choco install gh --version=2.46.0 -y --no-progress --error-action Stop
          
          # 刷新环境变量
          Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1" -ErrorAction Stop
          refreshenv -ErrorAction Stop

          # 校验工具
          $7zExists = Get-Command 7z -ErrorAction SilentlyContinue
          $ghExists = Get-Command gh -ErrorAction SilentlyContinue
          if (-not $7zExists -or -not $ghExists) {
              Write-Error "7-Zip或GitHub CLI安装失败！"
              exit 1
          }
          Write-Host "✅ 依赖安装完成"
        shell: pwsh
        env:
          CHOCOLATEY_INTERACTIVE: "false"

      # 步骤3：配置GitHub CLI认证
      - name: Authenticate GitHub CLI
        needs: install_deps  # 依赖安装完成才执行
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}" -ErrorAction Stop
          gh auth status -ErrorAction Stop
          Write-Host "✅ GitHub CLI认证成功"
        shell: pwsh

      # 步骤4：创建工作目录（强制设置，确保环境变量有值）
      - name: Create working directory
        needs: authenticate_github_cli
        id: create_workdir  # 标记步骤ID
        run: |
          # 强制设置工作目录，避免为空
          $defaultWorkDir = "$env:USERPROFILE\Win7_Workflow"
          # 确保目录创建成功
          New-Item -Path $defaultWorkDir -ItemType Directory -Force -ErrorAction Stop | Out-Null
          # 写入环境变量（强制覆盖）
          echo "WORK_DIR=$defaultWorkDir" >> $env:GITHUB_ENV
          # 输出到步骤输出，双重保障
          echo "work_dir=$defaultWorkDir" >> $env:GITHUB_OUTPUT
          Write-Host "✅ 工作目录创建完成：$defaultWorkDir"
        shell: pwsh

      # 步骤5：处理Win7包（下载、解压、DISM）
      - name: Process Win7 packages
        needs: create_workdir
        run: |
          # 双重获取工作目录（环境变量 + 步骤输出，避免为空）
          $workDir = $env:WORK_DIR ?? ${{ steps.create_workdir.outputs.work_dir }}
          # 最终兜底：若仍为空，用默认路径
          if (-not $workDir -or $workDir -eq "") {
              $workDir = "$env:USERPROFILE\Win7_Workflow"
          }
          Write-Host "当前工作目录：$workDir"

          $7zPath = (Get-Command 7z).Source
          if (-not $7zPath) {
              Write-Error "7-Zip路径获取失败！"
              exit 1
          }

          # 通用处理函数（略，与上一版一致，仅增加工作目录校验）
          function Process-Win7Package {
              param(
                  [string[]]$DownloadUrls,
                  [string]$WimFileName,
                  [int]$ImageIndex,
                  [bool]$IsFirstPackage
              )
              # 函数内先校验工作目录
              if (-not (Test-Path $workDir)) {
                  Write-Error "工作目录不存在：$workDir"
                  exit 1
              }
              # 原有逻辑保持不变...
              # 下载、解压、DISM、清理逻辑（与上一版一致）
          }

          # 1. 处理x86旗舰版
          $urlsX86Ultimate = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003"
          )
          Process-Win7Package -DownloadUrls $urlsX86Ultimate -WimFileName "install_Windows7x86ULTIMATE.wim" -ImageIndex 5 -IsFirstPackage $true

          # 2. 处理x86企业版
          $urlsX86Enterprise = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002"
          )
          Process-Win7Package -DownloadUrls $urlsX86Enterprise -WimFileName "install_Windows7x86ENTERPRISE.wim" -ImageIndex 1 -IsFirstPackage $false

          # 3. 处理x64旗舰版
          $urlsX64Ultimate = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003"
          )
          Process-Win7Package -DownloadUrls $urlsX64Ultimate -WimFileName "install_Windows7x64ULTIMATE.wim" -ImageIndex 4 -IsFirstPackage $false

          # 4. 处理x64企业版
          $urlsX64Enterprise = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003"
          )
          Process-Win7Package -DownloadUrls $urlsX64Enterprise -WimFileName "install_Windows7x64ENTERPRISE.wim" -ImageIndex 4 -IsFirstPackage $false

          # WIM转ESD + 分卷压缩（原有逻辑不变）
          $win7WimPath = Join-Path $workDir "WIN7.wim"
          $win7EsdPath = Join-Path $workDir "WIN7.esd"
          dism /export-image /SourceImageFile:"$win7WimPath" /SourceIndex:1 /DestinationImageFile:"$win7EsdPath" /Compress:recovery /CheckIntegrity /Quiet
          if ($LASTEXITCODE -ne 0) {
              Write-Error "WIM转ESD失败！"
              exit 1
          }

          $esdArchive = Join-Path $workDir "WIN7_ESD.7z"
          & $7zPath a -t7z -v1950M -mx9 "$esdArchive" "$win7EsdPath" -y | Out-Null
          if ($LASTEXITCODE -ne 0) {
              Write-Error "分卷压缩失败！"
              exit 1
          }
          Write-Host "✅ Win7包处理完成"
        shell: pwsh

      # 步骤6：上传到GitHub Releases
      - name: Upload to GitHub Releases
        needs: process_win7_packages
        run: |
          # 同样做工作目录兜底
          $workDir = $env:WORK_DIR ?? ${{ steps.create_workdir.outputs.work_dir }} ?? "$env:USERPROFILE\Win7_Workflow"
          $releaseTag = "Windows7_ULT&ENT_32&64"

          # 原有上传逻辑不变...
          if (-not (gh release view $releaseTag -q .name 2> $null)) {
              gh release create $releaseTag --title "Windows7_ULT&ENT_32&64" --notes "Windows7 旗舰版+企业版 32+64位 ESD"
          }
          Get-ChildItem -Path $workDir -Filter "WIN7_ESD.7z.*" | ForEach-Object {
              gh release upload $releaseTag $_.FullName --clobber
          }
          Write-Host "✅ 上传完成"
        shell: pwsh

      # 步骤7：清理工作目录（核心修复：空值校验 + 兜底）
      - name: Cleanup working directory
        if: always()  # 始终执行，但先做严格校验
        run: |
          <# 
              核心修复：
              1. 多重兜底获取工作目录
              2. 先校验变量是否为空，再执行Test-Path
              3. 仅当目录存在时才删除
          #>
          # 方式1：从环境变量获取
          $workDir = $env:WORK_DIR
          # 方式2：从步骤输出获取（兜底1）
          if (-not $workDir -or $workDir -eq "") {
              $workDir = ${{ steps.create_workdir.outputs.work_dir }}
          }
          # 方式3：硬编码默认路径（兜底2）
          if (-not $workDir -or $workDir -eq "") {
              $workDir = "$env:USERPROFILE\Win7_Workflow"
          }

          # 最终校验：变量非空 + 路径存在，才执行删除
          if ($workDir -and $workDir -ne "" -and (Test-Path $workDir)) {
              try {
                  Remove-Item -Path $workDir -Recurse -Force -ErrorAction Stop
                  Write-Host "✅ 清理完成：$workDir"
              } catch {
                  Write-Warning "清理目录失败（非致命）：$_"
              }
          } else {
              Write-Host "ℹ️ 无需清理：工作目录为空或不存在"
          }
        shell: pwsh
