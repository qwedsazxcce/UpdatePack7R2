name: Windows_7_ULT&ENT_32&64

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-upload-esd:
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd
    env:
      # 下载地址变量（保持不变）
      install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
      install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
      install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
      install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
      install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
      install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
      install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
      install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
      install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
      install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
      install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
      install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
      
      # 核心配置变量
      ESD_NAME: "Windows_7_ULT&ENT_32&64.esd"
      CHUNK_SIZE: "1950M"
      RETRY_TIMES: 10
      RETRY_INTERVAL: 30
      TAG_NAME: "Windows7_ESD_Pack"
      GITHUB_REPO: ${{ github.repository }}

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 配置CMD编码和基础工具
        run: |
          chcp 936
          curl --version
          "C:\Program Files\7-Zip\7z.exe" --version
          winget install --id GitHub.cli -e --silent
          gh --version

      # ========== 重构：放弃通用bat，改用分步执行（规避CMD语法陷阱） ==========
      # 步骤1：处理x86旗舰版（索引5，分卷3个）
      - name: 处理Windows7 x86旗舰版
        run: |
          :: ===================== 处理x86旗舰版 =====================
          set "VER_ID=x86ULT"
          set "VOL_PREFIX=install_Windows7x86ULTIMATE"
          set "TARGET_INDEX=5"
          set "VOL_COUNT=3"
          
          :: 下载分卷
          echo 下载x86旗舰版分卷...
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            set "FILE_NAME=!VOL_PREFIX!_!VOL_NUM!"
            set "DOWN_URL=!%FILE_NAME%!"
            curl -L -o "!FILE_NAME!" "!DOWN_URL!"
            if errorlevel 1 (echo 下载"!FILE_NAME!"失败 && exit /b 1)
          )
          
          :: 解压分卷
          echo 解压x86旗舰版分卷...
          "C:\Program Files\7-Zip\7z.exe" x -y "!VOL_PREFIX!_001" -o"!VER_ID!_temp"
          if errorlevel 1 (echo 解压失败 && exit /b 1)
          
          :: 查找WIM文件
          echo 查找WIM文件...
          for /f "delims=" %%f in ('dir /b "!VER_ID!_temp\*.wim"') do set "WIM_FILE=!VER_ID!_temp\%%f"
          if not defined WIM_FILE (echo 未找到WIM文件 && exit /b 1)
          
          :: 转换/追加ESD
          echo 转换为ESD...
          if not exist "!ESD_NAME!" (
            dism /export-image /SourceImageFile:"!WIM_FILE!" /SourceIndex:!TARGET_INDEX! /DestinationImageFile:"!ESD_NAME!" /Compress:recovery /CheckIntegrity
          ) else (
            dism /export-image /SourceImageFile:"!WIM_FILE!" /SourceIndex:!TARGET_INDEX! /DestinationImageFile:"!ESD_NAME!" /Compress:recovery /CheckIntegrity /Append
          )
          if errorlevel 1 (echo ESD转换失败 && exit /b 1)
          
          :: 清理临时文件
          echo 清理临时文件...
          rmdir /s /q "!VER_ID!_temp"
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            del /f /q "!VOL_PREFIX!_!VOL_NUM!"
          )

      # 步骤2：处理x86企业版（索引1，分卷3个）
      - name: 处理Windows7 x86企业版
        run: |
          :: ===================== 处理x86企业版 =====================
          set "VER_ID=x86ENT"
          set "VOL_PREFIX=install_Windows7x86ENTERPRISE"
          set "TARGET_INDEX=1"
          set "VOL_COUNT=3"
          
          :: 下载分卷
          echo 下载x86企业版分卷...
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            set "FILE_NAME=!VOL_PREFIX!_!VOL_NUM!"
            set "DOWN_URL=!%FILE_NAME%!"
            curl -L -o "!FILE_NAME!" "!DOWN_URL!"
            if errorlevel 1 (echo 下载"!FILE_NAME!"失败 && exit /b 1)
          )
          
          :: 解压分卷
          echo 解压x86企业版分卷...
          "C:\Program Files\7-Zip\7z.exe" x -y "!VOL_PREFIX!_001" -o"!VER_ID!_temp"
          if errorlevel 1 (echo 解压失败 && exit /b 1)
          
          :: 查找WIM文件
          echo 查找WIM文件...
          for /f "delims=" %%f in ('dir /b "!VER_ID!_temp\*.wim"') do set "WIM_FILE=!VER_ID!_temp\%%f"
          if not defined WIM_FILE (echo 未找到WIM文件 && exit /b 1)
          
          :: 追加ESD
          echo 追加到ESD...
          dism /export-image /SourceImageFile:"!WIM_FILE!" /SourceIndex:!TARGET_INDEX! /DestinationImageFile:"!ESD_NAME!" /Compress:recovery /CheckIntegrity /Append
          if errorlevel 1 (echo ESD追加失败 && exit /b 1)
          
          :: 清理临时文件
          echo 清理临时文件...
          rmdir /s /q "!VER_ID!_temp"
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            del /f /q "!VOL_PREFIX!_!VOL_NUM!"
          )

      # 步骤3：处理x64旗舰版（索引4，分卷3个）
      - name: 处理Windows7 x64旗舰版
        run: |
          :: ===================== 处理x64旗舰版 =====================
          set "VER_ID=x64ULT"
          set "VOL_PREFIX=install_Windows7x64ULTIMATE"
          set "TARGET_INDEX=4"
          set "VOL_COUNT=3"
          
          :: 下载分卷
          echo 下载x64旗舰版分卷...
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            set "FILE_NAME=!VOL_PREFIX!_!VOL_NUM!"
            set "DOWN_URL=!%FILE_NAME%!"
            curl -L -o "!FILE_NAME!" "!DOWN_URL!"
            if errorlevel 1 (echo 下载"!FILE_NAME!"失败 && exit /b 1)
          )
          
          :: 解压分卷
          echo 解压x64旗舰版分卷...
          "C:\Program Files\7-Zip\7z.exe" x -y "!VOL_PREFIX!_001" -o"!VER_ID!_temp"
          if errorlevel 1 (echo 解压失败 && exit /b 1)
          
          :: 查找WIM文件
          echo 查找WIM文件...
          for /f "delims=" %%f in ('dir /b "!VER_ID!_temp\*.wim"') do set "WIM_FILE=!VER_ID!_temp\%%f"
          if not defined WIM_FILE (echo 未找到WIM文件 && exit /b 1)
          
          :: 追加ESD
          echo 追加到ESD...
          dism /export-image /SourceImageFile:"!WIM_FILE!" /SourceIndex:!TARGET_INDEX! /DestinationImageFile:"!ESD_NAME!" /Compress:recovery /CheckIntegrity /Append
          if errorlevel 1 (echo ESD追加失败 && exit /b 1)
          
          :: 清理临时文件
          echo 清理临时文件...
          rmdir /s /q "!VER_ID!_temp"
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            del /f /q "!VOL_PREFIX!_!VOL_NUM!"
          )

      # 步骤4：处理x64企业版（索引1，分卷3个）
      - name: 处理Windows7 x64企业版
        run: |
          :: ===================== 处理x64企业版 =====================
          set "VER_ID=x64ENT"
          set "VOL_PREFIX=install_Windows7x64ENTERPRISE"
          set "TARGET_INDEX=1"
          set "VOL_COUNT=3"
          
          :: 下载分卷
          echo 下载x64企业版分卷...
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            set "FILE_NAME=!VOL_PREFIX!_!VOL_NUM!"
            set "DOWN_URL=!%FILE_NAME%!"
            curl -L -o "!FILE_NAME!" "!DOWN_URL!"
            if errorlevel 1 (echo 下载"!FILE_NAME!"失败 && exit /b 1)
          )
          
          :: 解压分卷
          echo 解压x64企业版分卷...
          "C:\Program Files\7-Zip\7z.exe" x -y "!VOL_PREFIX!_001" -o"!VER_ID!_temp"
          if errorlevel 1 (echo 解压失败 && exit /b 1)
          
          :: 查找WIM文件
          echo 查找WIM文件...
          for /f "delims=" %%f in ('dir /b "!VER_ID!_temp\*.wim"') do set "WIM_FILE=!VER_ID!_temp\%%f"
          if not defined WIM_FILE (echo 未找到WIM文件 && exit /b 1)
          
          :: 追加ESD
          echo 追加到ESD...
          dism /export-image /SourceImageFile:"!WIM_FILE!" /SourceIndex:!TARGET_INDEX! /DestinationImageFile:"!ESD_NAME!" /Compress:recovery /CheckIntegrity /Append
          if errorlevel 1 (echo ESD追加失败 && exit /b 1)
          
          :: 清理临时文件
          echo 清理临时文件...
          rmdir /s /q "!VER_ID!_temp"
          for /L %%i in (1,1,!VOL_COUNT!) do (
            set "VOL_NUM=00%%i"
            set "VOL_NUM=!VOL_NUM:~-3!"
            del /f /q "!VOL_PREFIX!_!VOL_NUM!"
          )

      # 后续步骤保持不变（压缩+上传+清理）
      - name: 分卷压缩ESD文件（1950M）
        run: |
          echo 开始分卷压缩ESD文件，分卷大小：%CHUNK_SIZE%
          "C:\Program Files\7-Zip\7z.exe" a -v%CHUNK_SIZE% -y "%ESD_NAME%.7z" "%ESD_NAME%"
          if errorlevel 1 (echo 分卷压缩失败 && exit /b 1)
          del /f /q "%ESD_NAME%"
          dir /b "%ESD_NAME%.7z.*"

      - name: 认证GitHub CLI
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | gh auth login --with-token
          gh auth status
          if errorlevel 1 (echo GH CLI认证失败 && exit /b 1)

      - name: 删除原有Release和Tag
        run: |
          gh release delete %TAG_NAME% -y --repo %GITHUB_REPO% 2>nul || echo 无原有Release，跳过
          git tag -d %TAG_NAME% 2>nul || echo 无原有Tag，跳过
          git push origin --delete %TAG_NAME% 2>nul || echo 推送删除Tag失败（可能不存在）

      - name: 上传分卷文件到Release（重试10次）
        run: |
          gh release create %TAG_NAME% --title "%ESD_NAME%" --notes "Windows7 ESD打包文件" --repo %GITHUB_REPO%
          
          set "RETRY=0"
          :UPLOAD_LOOP
          if !RETRY! geq %RETRY_TIMES% (echo 上传重试达上限 && exit /b 1)
          
          echo 第!RETRY!次上传尝试...
          for /f "delims=" %%f in ('dir /b "%ESD_NAME%.7z.*"') do (
            gh release upload %TAG_NAME% "%%f" --repo %GITHUB_REPO%
            if errorlevel 1 (
              echo 上传"%%f"失败，等待%RETRY_INTERVAL%秒重试...
              timeout /t %RETRY_INTERVAL% /nobreak >nul
              set /a RETRY+=1
              goto UPLOAD_LOOP
            )
            echo 上传"%%f"成功
          )
          echo 所有分卷文件上传完成

      - name: 清理所有临时文件
        if: always()
        run: |
          del /f /q install_Windows7*
          del /f /q "%ESD_NAME%.7z.*"
          rmdir /s /q x86ULT_temp x86ENT_temp x64ULT_temp x64ENT_temp
          echo 清理完成
