name: Windows_7_ULT&ENT_32&64

on:
  workflow_dispatch:

env:
  # 固定下载地址变量
  install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
  install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
  install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
  install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
  install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
  install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
  install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
  install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
  install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
  install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
  install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
  install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
  # 统一ESD文件名
  MAIN_ESD_NAME: Windows_7_ULT&ENT_32&64.esd
  # 7z分卷大小
  SPLIT_VOLUME_SIZE: 1950M
  # 版本处理配置（明确指定5号索引）
  VERSION_CONFIG: |
    [
      {"Name":"Windows7x86ULTIMATE","ESDIndex":5,"Parts":3},  # 强制指定5号索引
      {"Name":"Windows7x86ENTERPRISE","ESDIndex":1,"Parts":3},
      {"Name":"Windows7x64ULTIMATE","ESDIndex":4,"Parts":3},
      {"Name":"Windows7x64ENTERPRISE","ESDIndex":1,"Parts":3}
    ]

jobs:
  process_and_upload:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    
    steps:
      # ==============================================
      # 1. 检出代码
      # ==============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==============================================
      # 2. 编码配置
      # ==============================================
      - name: Critical encoding setup
        run: |
          try {
            $encodingProvider = [System.Text.CodePagesEncodingProvider]::Instance
            [System.Text.Encoding]::RegisterProvider($encodingProvider)
            $global:ANSI_ENCODING = [System.Text.Encoding]::GetEncoding(936)
          } catch {
            Write-Warning "ANSI编码加载失败，降级为UTF8：$_"
            $global:ANSI_ENCODING = [System.Text.Encoding]::UTF8
          }
          [Console]::OutputEncoding = $global:ANSI_ENCODING
          Write-Host "编码配置完成：$($global:ANSI_ENCODING.EncodingName)"

      # ==============================================
      # 3. 安装GitHub CLI
      # ==============================================
      - name: Setup GitHub CLI
        run: |
          winget install --id GitHub.cli --silent --accept-package-agreements --accept-source-agreements
          Start-Sleep -Seconds 5
          $env:GH_TOKEN | gh auth login --with-token
          gh auth status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================================
      # 4. 初始化ESD文件
      # ==============================================
      - name: Initialize main ESD file
        run: |
          $mainESD = $env:MAIN_ESD_NAME
          if (Test-Path $mainESD) { Remove-Item -Path $mainESD -Force }
          New-Item -Path $mainESD -ItemType File -Force | Out-Null
          Write-Host "ESD文件创建成功：$((Get-Item $mainESD).FullName)"

      # ==============================================
      # 5. 核心处理逻辑（修复索引提取+指定5号索引）
      # ==============================================
      - name: Process all Windows7 versions
        run: |
          # 下载分卷函数
          function Download-7zParts {
            param(
              [string]$VerName,
              [int]$PartCount
            )
            $allPartsDownloaded = $true
            Write-Host "`n开始下载$VerName分卷包（共$PartCount个）..."
            
            for ($i=1; $i -le $PartCount; $i++) {
              $partNum = "{0:D3}" -f $i
              $downloadUrl = [Environment]::GetEnvironmentVariable("install_${VerName}_${partNum}")
              $savePath = "$VerName.7z.$partNum"
              $retryCount = 3
              $retryInterval = 3
              $downloadOk = $false
              
              if (-not $downloadUrl) {
                Write-Error "   分卷 $i：URL为空，无法下载"
                $allPartsDownloaded = $false
                continue
              }
              
              Write-Host "   分卷 $i：URL=$downloadUrl，保存路径=$savePath"
              
              for ($retry=1; $retry -le $retryCount; $retry++) {
                try {
                  if (Test-Path $savePath) { Remove-Item -Path $savePath -Force }
                  
                  & curl.exe -L -o "$savePath" $downloadUrl
                  Start-Sleep -Seconds 1
                  
                  if ($LASTEXITCODE -eq 0 -and (Test-Path $savePath) -and ((Get-Item $savePath).Length -gt 0)) {
                    $fileSize = [math]::Round((Get-Item $savePath).Length / 1MB, 2)
                    Write-Host "      重试$retry：下载成功（$fileSize MB）"
                    $downloadOk = $true
                    break
                  } else {
                    throw "curl退出码：$LASTEXITCODE，文件大小：$((Get-Item $savePath -ErrorAction SilentlyContinue).Length) 字节"
                  }
                } catch {
                  Write-Warning "      重试$retry：下载失败：$_"
                  if ($retry -eq $retryCount) {
                    Write-Error "      分卷 $i：$retryCount 次重试均失败"
                    $allPartsDownloaded = $false
                  } else {
                    Start-Sleep -Seconds $retryInterval
                  }
                }
              }
              
              if (-not $downloadOk) { break }
            }
            
            return $allPartsDownloaded
          }

          # 主处理逻辑
          $versions = $env:VERSION_CONFIG | ConvertFrom-Json
          $mainESD = $env:MAIN_ESD_NAME
          
          foreach ($ver in $versions) {
            $verName = $ver.Name
            $targetIndex = $ver.ESDIndex  # 明确读取配置中的索引（5）
            $partCount = $ver.Parts
            $unzipRetryCount = 1
            
            Write-Host "`n=================================================="
            Write-Host "处理版本：$verName | 指定索引：$targetIndex"
            Write-Host "=================================================="
            
            # 1. 下载分卷
            $downloadSuccess = Download-7zParts -VerName $verName -PartCount $partCount
            if (-not $downloadSuccess) { throw "$verName 分卷下载失败" }

            # 2. 解压分卷
            Write-Host "`n步骤2：解压分卷包..."
            $first7z = "$verName.7z.001"
            $extractDir = "$verName"
            $first7z_Abs = (Resolve-Path $first7z).Path
            $extractDir_Abs = Join-Path (Resolve-Path .).Path $extractDir
            
            $unzipOk = $false
            for ($unzipRetry=0; $unzipRetry -le $unzipRetryCount; $unzipRetry++) {
              if ($unzipRetry -gt 0) {
                Write-Host "解压失败，重试$unzipRetry：删除分卷并重新下载..."
                Get-ChildItem -Path "$verName.7z.*" | Remove-Item -Force
                $downloadSuccess = Download-7zParts -VerName $verName -PartCount $partCount
                if (-not $downloadSuccess) { throw "$verName 重新下载失败" }
                $first7z_Abs = (Resolve-Path $first7z).Path
              }

              & 7z.exe x "$first7z_Abs" -o"$extractDir_Abs" -y
              if ($LASTEXITCODE -eq 0) {
                Write-Host "解压完成：$extractDir_Abs"
                $unzipOk = $true
                break
              } else {
                Write-Error "解压失败（7z退出码：$LASTEXITCODE）"
              }
            }
            if (-not $unzipOk) { throw "$verName 解压失败" }

            # 3. 读取WIM信息（核心修复：正确提取所有索引）
            Write-Host "`n步骤3：读取WIM文件信息 | 验证指定索引：$targetIndex"
            $wimFiles = Get-ChildItem -Path $extractDir_Abs -Filter *.wim -Recurse
            if ($wimFiles.Count -eq 0) { throw "未找到WIM文件" }
            $wimPath = $wimFiles[0].FullName
            
            Write-Host "   WIM文件路径：$wimPath"
            Write-Host "   WIM文件大小：$([math]::Round($wimFiles[0].Length / 1GB, 2)) GB"
            
            # 修复：正确提取DISM输出中的所有索引（解决仅抓到索引1的问题）
            Write-Host "`n   读取WIM所有索引（完整DISM输出）："
            $dismFullOutput = & dism /Get-WimInfo /WimFile:$wimPath 2>&1
            $dismStr = $dismFullOutput | Out-String
            Write-Host "--------------------------------------------------"
            Write-Host $dismStr  # 打印完整DISM输出，便于验证
            Write-Host "--------------------------------------------------"
            
            # 正确正则：匹配所有Index行（修复之前的正则错误）
            $indexMatches = [regex]::Matches($dismStr, '(?mi)^Index\s*:\s*(\d+)')
            $validIndexes = @()
            foreach ($match in $indexMatches) {
              $validIndexes += $match.Groups[1].Value
            }
            $validIndexes = $validIndexes | Select-Object -Unique | Sort-Object { [int]$_ }
            
            Write-Host "   解析出WIM有效索引：$($validIndexes -join ", ")"
            
            # 验证指定索引是否存在
            if (-not $validIndexes.Contains($targetIndex.ToString())) {
              throw "指定索引$targetIndex不存在！WIM实际索引：$($validIndexes -join ", ")"
            }

            # 4. 读取指定索引的映像名
            Write-Host "`n步骤4：读取索引$targetIndex的映像名..."
            $dismIndexOutput = & dism /Get-WimInfo /WimFile:$wimPath /Index:$targetIndex 2>&1
            $dismIndexStr = $dismIndexOutput | Out-String
            
            $imageNameMatch = [regex]::Match($dismIndexStr, '(?mi)^Image Name\s*:\s*(.+)')
            if ($imageNameMatch.Success) {
              $imageName = $imageNameMatch.Groups[1].Value.Trim()
              Write-Host "   映像名：$imageName"
            } else {
              throw "未找到索引$targetIndex的映像名`nDISM输出：$dismIndexStr"
            }

            # 5. WIM转ESD
            Write-Host "`n步骤5：转换索引$targetIndex为ESD并追加..."
            & dism /Export-Image `
              /SourceImageFile:$wimPath `
              /SourceIndex:$targetIndex `
              /DestinationImageFile:$mainESD `
              /Compress:recovery `
              /CheckIntegrity `
              /Append
            
            if ($LASTEXITCODE -ne 0) { throw "WIM转ESD失败（DISM退出码：$LASTEXITCODE）" }
            Write-Host "ESD追加成功，当前ESD大小：$([math]::Round((Get-Item $mainESD).Length / 1GB, 2)) GB"

            # 6. 清理临时文件
            Write-Host "`n步骤6：清理临时文件..."
            Remove-Item -Path $wimPath -Force -ErrorAction SilentlyContinue
            Remove-Item -Path $extractDir_Abs -Recurse -Force -ErrorAction SilentlyContinue
            Get-ChildItem -Path "$verName.7z.*" | Remove-Item -Force -ErrorAction SilentlyContinue
            Write-Host "$verName 处理完成！"
          }

      # ==============================================
      # 6. 分卷压缩ESD
      # ==============================================
      - name: Split ESD to 7z parts
        run: |
          $mainESD = $env:MAIN_ESD_NAME
          $splitSize = $env:SPLIT_VOLUME_SIZE
          $7zPrefix = "$mainESD.7z"
          
          Write-Host "`n分卷压缩ESD：$mainESD | 分卷大小：$splitSize"
          if (-not (Test-Path $mainESD)) { throw "ESD文件不存在" }
          
          & 7z.exe a "$7zPrefix" "$mainESD" -v$splitSize -y -mx=9
          if ($LASTEXITCODE -ne 0) { throw "7z分卷失败（退出码：$LASTEXITCODE）" }
          
          Remove-Item -Path $mainESD -Force
          $splitFiles = Get-ChildItem -Path "$7zPrefix.*"
          Write-Host "分卷完成，生成文件：$($splitFiles.Name -join ", ")"

      # ==============================================
      # 7. 发布Release
      # ==============================================
      - name: Publish Release
        run: |
          $releaseTag = "Windows_7_ULT&ENT_32&64"
          $7zPrefix = "$($env:MAIN_ESD_NAME).7z"
          $retryTimes = 10
          $retryInterval = 30

          # 删除旧Release/Tag
          Write-Host "`n删除旧Release/Tag：$releaseTag"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              gh release delete $releaseTag -y 2>&1 | Out-Null
              git tag -d $releaseTag 2>&1 | Out-Null
              git push origin --delete $releaseTag 2>&1 | Out-Null
              break
            } catch { Start-Sleep -Seconds $retryInterval }
          }

          # 创建新Release
          Write-Host "创建新Release：$releaseTag"
          for ($i=1; $i -le $retryTimes; $i++) {
            try {
              gh release create $releaseTag `
                --title "$releaseTag" `
                --notes "Windows7 ULT&ENT 32&64 合并ESD | 7z分卷$splitSize"
              break
            } catch { Start-Sleep -Seconds $retryInterval }
          }

          # 上传分卷
          $splitFiles = Get-ChildItem -Path "$7zPrefix.*"
          Write-Host "上传$($splitFiles.Count)个分卷文件..."
          foreach ($file in $splitFiles) {
            for ($i=1; $i -le $retryTimes; $i++) {
              try {
                gh release upload $releaseTag "$($file.FullName)" --clobber
                Write-Host "   成功上传：$($file.Name)"
                break
              } catch { Start-Sleep -Seconds $retryInterval }
            }
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================================
      # 8. 最终清理
      # ==============================================
      - name: Final cleanup
        run: |
          Write-Host "`n最终清理临时文件..."
          $7zPrefix = "$($env:MAIN_ESD_NAME).7z"
          Get-ChildItem -Path @("*.7z.*", "*.wim", $env:MAIN_ESD_NAME) -ErrorAction SilentlyContinue | Remove-Item -Force
          Get-ChildItem -Path * -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "Windows7" } | Remove-Item -Recurse -Force
          Write-Host "清理完成！"
