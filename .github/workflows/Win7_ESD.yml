# GitHub Actions工作流：Windows7 WIM转ESD并上传Releases
name: Windows7_WIM2ESD  # 工作流名称（第一行必填，且是合法YAML键）
on:
  workflow_dispatch:  # 手动触发（也可添加push/tag触发）
  push:
    branches: [ main ]  # 可选：推送到main分支时触发
jobs:
  build_win7_esd:
    runs-on: windows-2022  # 使用Windows Server 2022 runner（自带DISM）
    timeout-minutes: 120  # 延长超时时间（处理大文件需要）
    steps:
      # 步骤1：检出仓库（用于后续上传Releases）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装依赖（7-Zip、GitHub CLI）
      - name: Install dependencies
        run: |
          # 安装7-Zip（添加到环境变量）
          choco install 7zip -y
          refreshenv
          # 安装GitHub CLI
          winget install GitHub.cli -y --accept-package-agreements --accept-source-agreements
          refreshenv
        shell: pwsh

      # 步骤3：配置GitHub CLI认证（用于上传Releases）
      - name: Authenticate GitHub CLI
        run: |
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
        shell: pwsh

      # 步骤4：创建工作目录
      - name: Create working directory
        run: |
          $workDir = "D:\Win7_Workflow"
          if (-not (Test-Path $workDir)) {
              New-Item -Path $workDir -ItemType Directory -Force | Out-Null
          }
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
        shell: pwsh

      # 步骤5：定义通用处理函数并执行所有包的下载/解压/DISM操作
      - name: Process all Win7 packages
        run: |
          # 通用处理函数
          function Process-Win7Package {
              param(
                  [string[]]$DownloadUrls,
                  [string]$WimFileName,
                  [int]$ImageIndex,
                  [bool]$IsFirstPackage
              )
              $workDir = $env:WORK_DIR
              
              # 下载分卷包
              foreach ($url in $DownloadUrls) {
                  $fileName = $url.Split("/")[-1]
                  $savePath = Join-Path $workDir $fileName
                  if (-not (Test-Path $savePath)) {
                      Write-Host "Downloading: $fileName"
                      Invoke-WebRequest -Uri $url -OutFile $savePath -UseBasicParsing -TimeoutSec 300
                  } else {
                      Write-Host "File exists, skip: $fileName"
                  }
              }

              # 解压分卷（仅解压001文件）
              $firstArchive = $DownloadUrls[0].Split("/")[-1]
              $archivePath = Join-Path $workDir $firstArchive
              Write-Host "Extracting: $firstArchive"
              & "C:\Program Files\7-Zip\7z.exe" x $archivePath -o"$workDir" -y | Out-Null

              # DISM操作：创建/追加镜像
              $sourceWimPath = Join-Path $workDir $WimFileName
              $win7WimPath = Join-Path $workDir "WIN7.wim"
              if (-not (Test-Path $sourceWimPath)) {
                  Write-Error "WIM file not found: $sourceWimPath"
                  exit 1
              }

              Write-Host "Processing WIM: $WimFileName (Index: $ImageIndex)"
              if ($IsFirstPackage) {
                  dism /export-image /SourceImageFile:"$sourceWimPath" /SourceIndex:$ImageIndex /DestinationImageFile:"$win7WimPath" /Compress:max /CheckIntegrity
              } else {
                  dism /append-image /ImageFile:"$win7WimPath" /SourceImageFile:"$sourceWimPath" /SourceIndex:$ImageIndex /Compress:max /CheckIntegrity
              }

              # 删除原WIM文件
              if (Test-Path $sourceWimPath) {
                  Remove-Item -Path $sourceWimPath -Force
                  Write-Host "Deleted original WIM: $sourceWimPath"
              }

              # 清理分卷包（节省空间）
              foreach ($url in $DownloadUrls) {
                  $fileName = $url.Split("/")[-1]
                  $filePath = Join-Path $workDir $fileName
                  if (Test-Path $filePath) {
                      Remove-Item -Path $filePath -Force
                  }
              }
          }

          # 处理x86旗舰版（创建WIN7.wim）
          $urlsX86Ultimate = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003"
          )
          Process-Win7Package -DownloadUrls $urlsX86Ultimate -WimFileName "install_Windows7x86ULTIMATE.wim" -ImageIndex 5 -IsFirstPackage $true

          # 处理x86企业版（修正文件名）
          $urlsX86Enterprise = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002"
          )
          Process-Win7Package -DownloadUrls $urlsX86Enterprise -WimFileName "install_Windows7x86ENTERPRISE.wim" -ImageIndex 1 -IsFirstPackage $false

          # 处理x64旗舰版
          $urlsX64Ultimate = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003"
          )
          Process-Win7Package -DownloadUrls $urlsX64Ultimate -WimFileName "install_Windows7x64ULTIMATE.wim" -ImageIndex 4 -IsFirstPackage $false

          # 处理x64企业版
          $urlsX64Enterprise = @(
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002",
              "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003"
          )
          Process-Win7Package -DownloadUrls $urlsX64Enterprise -WimFileName "install_Windows7x64ENTERPRISE.wim" -ImageIndex 4 -IsFirstPackage $false

          # WIM转ESD（recovery压缩）
          $win7WimPath = Join-Path $env:WORK_DIR "WIN7.wim"
          $win7EsdPath = Join-Path $env:WORK_DIR "WIN7.esd"
          Write-Host "Converting WIM to ESD..."
          dism /export-image /SourceImageFile:"$win7WimPath" /SourceIndex:1 /DestinationImageFile:"$win7EsdPath" /Compress:recovery /CheckIntegrity

          # 分卷压缩ESD（1950M/卷）
          Write-Host "Splitting ESD into 1950M volumes..."
          $esdArchive = Join-Path $env:WORK_DIR "WIN7_ESD.7z"
          & "C:\Program Files\7-Zip\7z.exe" a -t7z -v1950M -mx9 "$esdArchive" "$win7EsdPath" -y | Out-Null
        shell: pwsh

      # 步骤6：上传到GitHub Releases
      - name: Upload to GitHub Releases
        run: |
          $releaseTag = "Windows7_ULT&ENT_32&64"
          $workDir = $env:WORK_DIR
          
          # 创建Release（已存在则跳过）
          gh release view $releaseTag 2> $null || gh release create $releaseTag --title "Windows7_ULT&ENT_32&64" --notes "Windows7 Ultimate+Enterprise 32&64bit ESD"
          
          # 上传所有分卷包
          Get-ChildItem -Path $workDir -Filter "WIN7_ESD.7z.*" | ForEach-Object {
              Write-Host "Uploading: $($_.Name)"
              gh release upload $releaseTag $_.FullName --clobber
          }
        shell: pwsh
