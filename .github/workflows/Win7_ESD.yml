name: Windows7_ESD (Resumable)

on:
  workflow_dispatch:

env:
  # å…¨å±€UTF8ç¼–ç 
  PYTHONIOENCODING: utf-8
  LC_ALL: C.UTF-8
  LANG: C.UTF-8
  # ç›®æ ‡æ–‡ä»¶å‘½å
  TARGET_WIM: Windows7_ULT&ENT_32&64.wim
  TARGET_ESD: Windows7_ULT&ENT_32&64.esd
  SPLIT_SIZE: 1950M
  # å‘å¸ƒæ ‡ç­¾/åç§°
  RELEASE_TAG: Windows7_ULT&ENT_32&64
  # 4ç»„å‹ç¼©åŒ…URL + å¯¹åº”æ˜ åƒç´¢å¼•
  # ç»„1: Windows7x86ULTIMATE (3ä¸ªåˆ†å·ï¼Œç¬¬5ä¸ªæ˜ åƒ)
  URLS_X86_ULT: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
  IMG_INDEX_X86_ULT: 5
  # ç»„2: Windows7x86ENTERPRISE (2ä¸ªåˆ†å·ï¼Œç¬¬1ä¸ªæ˜ åƒ)
  URLS_X86_ENT: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
  IMG_INDEX_X86_ENT: 1
  # ç»„3: Windows7x64ULTIMATE (3ä¸ªåˆ†å·ï¼Œç¬¬4ä¸ªæ˜ åƒ)
  URLS_X64_ULT: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
  IMG_INDEX_X64_ULT: 4
  # ç»„4: Windows7x64ENTERPRISE (3ä¸ªåˆ†å·ï¼Œç¬¬1ä¸ªæ˜ åƒ)
  URLS_X64_ENT: >
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002,
    https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
  IMG_INDEX_X64_ENT: 1

# æ‹†åˆ†4ä¸ªJobï¼Œæ¯æ­¥åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ŒArtifactæŒä¹…åŒ–
jobs:
  # Job1: ä¸‹è½½+è§£å‹+å¯¼å‡ºæŒ‡å®šæ˜ åƒâ†’åˆå¹¶ä¸ºç›®æ ‡WIM (æ ¸å¿ƒæ­¥éª¤ï¼Œè€—æ—¶æœ€é•¿)
  build-wim:
    runs-on: windows-latest
    timeout-minutes: 180
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Force Global UTF8 Encoding
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.UTF8Encoding]::UTF8
          $PSDefaultParameterValues['*:Encoding'] = 'utf8'
          Write-Host "âœ… UTF8 encoding enabled"

      - name: Install 7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              Write-Host "ğŸ”§ Installing 7-Zip..."
              choco install 7zip -y --no-progress --ignore-checksums --force
          }
          if (-not (Test-Path $7zPath)) { throw "âŒ 7-Zip installation failed" }
          $env:PATH += ";C:\Program Files\7-Zip"
          Write-Host "âœ… 7-Zip installed: $7zPath"

      - name: Build Target WIM (Export Specified Images)
        shell: powershell
        run: |
          # å®šä¹‰æ ¸å¿ƒå‡½æ•°ï¼šå¤„ç†å•ç»„åˆ†å·â†’è§£å‹â†’å¯¼å‡ºæŒ‡å®šæ˜ åƒâ†’åˆ é™¤ä¸´æ—¶æ–‡ä»¶
          function Process-7z-Export-Image {
              param(
                  [string]$UrlCsv,
                  [int]$ImageIndex,
                  [string]$VolumeName,
                  [string]$TargetWim
              )

              Write-Host "`n====================================="
              Write-Host "ğŸ”„ Processing: $VolumeName (Image Index: $ImageIndex)"
              Write-Host "====================================="

              # 1. æ¸…ç†æ—§ä¸´æ—¶æ–‡ä»¶ï¼ˆé˜²æ®‹ç•™ï¼‰
              $tempRoot = "$env:GITHUB_WORKSPACE\temp_$VolumeName"
              if (Test-Path $tempRoot) {
                  Write-Host "ğŸ§¹ Cleaning old temp dir: $tempRoot"
                  Remove-Item -Path $tempRoot -Recurse -Force -ErrorAction SilentlyContinue
              }

              # 2. åˆ›å»ºä¸´æ—¶ç›®å½•
              $dlDir = New-Item -Path "$tempRoot\downloads" -ItemType Directory -Force
              $extractDir = New-Item -Path "$tempRoot\extract" -ItemType Directory -Force
              Write-Host "ğŸ“ Temp dir created: $tempRoot"

              try {
                  # 3. æ‹†åˆ†å¹¶æ¸…æ´—URLï¼ˆå»é™¤ç©ºæ ¼/æ¢è¡Œï¼‰
                  $urls = $UrlCsv -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
                  if ($urls.Count -eq 0) { throw "âŒ Empty URL list for $VolumeName" }
                  Write-Host "ğŸ“¥ Downloading $($urls.Count) volumes..."

                  # 4. ä¸‹è½½æ‰€æœ‰åˆ†å·
                  foreach ($url in $urls) {
                      $fileName = [System.IO.Path]::GetFileName($url)
                      $savePath = "$dlDir\$fileName"
                      
                      Write-Host "â¬‡ï¸ Downloading: $fileName"
                      curl.exe --progress-bar -L -f -o "$savePath" "$url"
                      
                      # éªŒè¯ä¸‹è½½
                      if (-not (Test-Path $savePath) -or (Get-Item $savePath).Length -lt 1024) {
                          throw "âŒ Download failed: $fileName (empty or missing)"
                      }
                      $fileSize = [math]::Round((Get-Item $savePath).Length/1GB,2)
                      Write-Host "âœ… Downloaded: $fileName ($fileSize GB)"
                  }

                  # 5. è§£å‹7zåˆ†å·ï¼ˆæ‰¾001åˆ†å·ï¼‰
                  $7z001 = Get-ChildItem -Path $dlDir -Filter "*.7z.001" | Select-Object -First 1
                  if (-not $7z001) { throw "âŒ 7z.001 volume not found for $VolumeName" }
                  
                  Write-Host "ğŸ—œï¸ Extracting: $($7z001.Name)"
                  & "C:\Program Files\7-Zip\7z.exe" x -y -bb1 -o"$extractDir" "$($7z001.FullName)"
                  if ($LASTEXITCODE -ne 0) { throw "âŒ 7z extract failed (code: $LASTEXITCODE)" }
                  Write-Host "âœ… Extraction completed"

                  # 6. æŸ¥æ‰¾è§£å‹åçš„WIMæ–‡ä»¶ï¼ˆé€’å½’æ‰¾ç¬¬ä¸€ä¸ª.wimï¼‰
                  Write-Host "ğŸ” Finding WIM file in extract dir..."
                  $wimFiles = Get-ChildItem -Path $extractDir -Filter "*.wim" -Recurse
                  if ($wimFiles.Count -eq 0) {
                      Write-Host "âŒ No WIM files found! Extract dir content:"
                      Get-ChildItem -Path $extractDir -Recurse | ForEach-Object { Write-Host " - $($_.FullName)" }
                      throw "âŒ WIM file not found for $VolumeName"
                  }
                  $sourceWim = $wimFiles | Select-Object -First 1
                  Write-Host "âœ… Found source WIM: $($sourceWim.FullName)"

                  # 7. å¯¼å‡ºæŒ‡å®šç´¢å¼•çš„æ˜ åƒåˆ°ç›®æ ‡WIM
                  Write-Host "ğŸ“¤ Exporting image $ImageIndex from $($sourceWim.Name)..."
                  if (-not (Test-Path $TargetWim)) {
                      # é¦–æ¬¡å¯¼å‡ºï¼šåˆ›å»ºæ–°WIM
                      dism /Export-Image `
                          /SourceImageFile:"$($sourceWim.FullName)" `
                          /SourceIndex:$ImageIndex `
                          /DestinationImageFile:"$TargetWim" `
                          /Compress:max `
                          /CheckIntegrity
                  } else {
                      # è¿½åŠ å¯¼å‡ºï¼šåˆå¹¶åˆ°ç°æœ‰WIM
                      dism /Export-Image `
                          /SourceImageFile:"$($sourceWim.FullName)" `
                          /SourceIndex:$ImageIndex `
                          /DestinationImageFile:"$TargetWim" `
                          /Compress:max `
                          /CheckIntegrity
                  }
                  
                  if ($LASTEXITCODE -ne 0) { throw "âŒ DISM export failed (code: $LASTEXITCODE)" }
                  Write-Host "âœ… Image $ImageIndex exported to $TargetWim"

              } catch {
                  Write-Host "âŒ Processing failed: $_" -ForegroundColor Red
                  throw $_
              } finally {
                  # 8. å¼ºåˆ¶åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ˆå…³é”®ï¼šæ¯æ­¥æ¸…ç†ï¼‰
                  Write-Host "ğŸ§¹ Deleting temp dir: $tempRoot"
                  Remove-Item -Path $tempRoot -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "âœ… Temp files cleaned"
              }
          }

          # ========== å¤„ç†4ç»„å‹ç¼©åŒ… ==========
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"

          # 1. å¤„ç†x86 ULTIMATE (Index 5)
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_X86_ULT `
              -ImageIndex $env:IMG_INDEX_X86_ULT `
              -VolumeName "Windows7x86ULTIMATE" `
              -TargetWim $finalWim

          # 2. å¤„ç†x86 ENTERPRISE (Index 1)
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_X86_ENT `
              -ImageIndex $env:IMG_INDEX_X86_ENT `
              -VolumeName "Windows7x86ENTERPRISE" `
              -TargetWim $finalWim

          # 3. å¤„ç†x64 ULTIMATE (Index 4)
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_X64_ULT `
              -ImageIndex $env:IMG_INDEX_X64_ULT `
              -VolumeName "Windows7x64ULTIMATE" `
              -TargetWim $finalWim

          # 4. å¤„ç†x64 ENTERPRISE (Index 1)
          Process-7z-Export-Image `
              -UrlCsv $env:URLS_X64_ENT `
              -ImageIndex $env:IMG_INDEX_X64_ENT `
              -VolumeName "Windows7x64ENTERPRISE" `
              -TargetWim $finalWim

          # ========== éªŒè¯æœ€ç»ˆWIM ==========
          if (-not (Test-Path $finalWim) -or (Get-Item $finalWim).Length -lt 1024) {
              throw "âŒ Final WIM file is empty or missing"
          }
          $wimSize = [math]::Round((Get-Item $finalWim).Length/1GB,2)
          Write-Host "âœ… Final WIM created successfully!"
          Write-Host "ğŸ“„ File: $finalWim"
          Write-Host "ğŸ“ Size: $wimSize GB"

          # ========== æ¸…ç†æ®‹ç•™ä¸´æ—¶æ–‡ä»¶ ==========
          $allTempDirs = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "temp_*" -Directory
          foreach ($dir in $allTempDirs) {
              Write-Host "ğŸ§¹ Cleaning leftover temp dir: $($dir.FullName)"
              Remove-Item -Path $dir.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }

      # ========== ä¸Šä¼ WIMåˆ°Artifact (é˜²æˆæœä¸¢å¤±) ==========
      - name: Upload WIM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows7-target-wim
          path: ${{ env.TARGET_WIM }}
          retention-days: 90
        env:
          ACTIONS_STEP_DEBUG: true
        run: |
          Write-Host "`nğŸ“¤ Uploading WIM to Artifact..."
          $wimPath = "${{ env.TARGET_WIM }}"
          $wimSize = [math]::Round((Get-Item $wimPath).Length/1GB,2)
          Write-Host "File: $wimPath"
          Write-Host "Size: $wimSize GB"
          Write-Host "Artifact Name: windows7-target-wim"

  # Job2: è½¬æ¢WIMâ†’ESD (ä¾èµ–Job1ï¼Œä¸‹è½½WIM Artifact)
  build-esd:
    needs: build-wim
    runs-on: windows-latest
    timeout-minutes: 90
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download WIM Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows7-target-wim
          path: ${{ github.workspace }}
        run: |
          Write-Host "ğŸ“¥ Downloading WIM Artifact..."
          $wimPath = "${{ github.workspace }}\${{ env.TARGET_WIM }}"
          if (-not (Test-Path $wimPath)) { throw "âŒ WIM Artifact not found" }
          Write-Host "âœ… WIM downloaded: $wimPath"

      - name: Force UTF8 Encoding
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::UTF8
          Write-Host "âœ… UTF8 encoding enabled"

      - name: Convert WIM to ESD (Recovery Compression)
        shell: powershell
        run: |
          $finalWim = "$env:GITHUB_WORKSPACE\$env:TARGET_WIM"
          $finalEsd = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"

          # 1. è·å–WIMä¸­çš„æ˜ åƒæ•°é‡ï¼ˆå…¼å®¹ä¸­è‹±æ–‡ï¼‰
          Write-Host "ğŸ” Getting image count from WIM..."
          $env:DISM_OUTPUT_LANGUAGE = "en-US"
          $dismOutput = dism /Get-WimInfo /WimFile:$finalWim 2>&1 | Out-String
          $imgMatches = [regex]::Matches($dismOutput, '(Index|ç´¢å¼•)\s*\:\s*(\d+)')
          $imgTotal = $imgMatches.Count
          
          if ($imgTotal -eq 0) {
              Write-Host "âš ï¸ No image count found, fallback to export index 1-4"
              $imgTotal = 4
          }
          Write-Host "âœ… Found $imgTotal images in WIM"

          # 2. è½¬æ¢æ‰€æœ‰æ˜ åƒåˆ°ESD (Recoveryå‹ç¼©ï¼Œä½“ç§¯æ›´å°)
          Write-Host "ğŸ—œï¸ Converting WIM to ESD (Recovery compression)..."
          for ($i=1; $i -le $imgTotal; $i++) {
              Write-Host "ğŸ“¤ Exporting image $i/$imgTotal to ESD..."
              dism /Export-Image `
                  /SourceImageFile:$finalWim `
                  /SourceIndex:$i `
                  /DestinationImageFile:$finalEsd `
                  /Compress:recovery `
                  /CheckIntegrity
              
              if ($LASTEXITCODE -ne 0) { throw "âŒ ESD export failed (image $i, code: $LASTEXITCODE)" }
              Write-Host "âœ… Image $i exported to ESD"
          }

          # 3. éªŒè¯ESD
          if (-not (Test-Path $finalEsd) -or (Get-Item $finalEsd).Length -lt 1024) {
              throw "âŒ Final ESD file is empty or missing"
          }
          $esdSize = [math]::Round((Get-Item $finalEsd).Length/1GB,2)
          Write-Host "âœ… ESD created successfully!"
          Write-Host "ğŸ“„ File: $finalEsd"
          Write-Host "ğŸ“ Size: $esdSize GB"

          # 4. åˆ é™¤æºWIM (èŠ‚çœç©ºé—´)
          Write-Host "ğŸ§¹ Deleting source WIM file..."
          Remove-Item -Path $finalWim -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… WIM file deleted"

      # ========== ä¸Šä¼ ESDåˆ°Artifact ==========
      - name: Upload ESD Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows7-target-esd
          path: ${{ env.TARGET_ESD }}
          retention-days: 90
        run: |
          Write-Host "`nğŸ“¤ Uploading ESD to Artifact..."
          $esdPath = "${{ github.workspace }}\${{ env.TARGET_ESD }}"
          $esdSize = [math]::Round((Get-Item $esdPath).Length/1GB,2)
          Write-Host "File: $esdPath"
          Write-Host "Size: $esdSize GB"
          Write-Host "Artifact Name: windows7-target-esd"

  # Job3: åˆ†å·å‹ç¼©ESD (1950Mï¼Œä¾èµ–Job2)
  split-esd:
    needs: build-esd
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download ESD Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows7-target-esd
          path: ${{ github.workspace }}
        run: |
          Write-Host "ğŸ“¥ Downloading ESD Artifact..."
          $esdPath = "${{ github.workspace }}\${{ env.TARGET_ESD }}"
          if (-not (Test-Path $esdPath)) { throw "âŒ ESD Artifact not found" }
          $esdSize = [math]::Round((Get-Item $esdPath).Length/1GB,2)
          Write-Host "âœ… ESD downloaded: $esdPath ($esdSize GB)"

      - name: Install 7-Zip
        shell: powershell
        run: |
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $7zPath)) {
              Write-Host "ğŸ”§ Installing 7-Zip..."
              choco install 7zip -y --no-progress --ignore-checksums --force
          }
          if (-not (Test-Path $7zPath)) { throw "âŒ 7-Zip installation failed" }
          Write-Host "âœ… 7-Zip installed: $7zPath"

      - name: Split ESD to 1950M Volumes (Hardcoded)
        shell: powershell
        run: |
          $esdFile = "$env:GITHUB_WORKSPACE\$env:TARGET_ESD"
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          $splitOutput = "$esdFile.7z"

          # 1. éªŒè¯ESDå­˜åœ¨
          if (-not (Test-Path $esdFile)) { throw "âŒ ESD file not found: $esdFile" }

          # 2. åˆ†å·å‹ç¼© (ç¡¬ç¼–ç 1950Mï¼Œé¿å…å˜é‡è§£æé”™è¯¯)
          Write-Host "ğŸ—œï¸ Splitting ESD to 1950M volumes..."
          Write-Host "Command: $7zPath a -y -mx=9 -v1950M ""$splitOutput"" ""$esdFile"""
          & $7zPath a -y -mx=9 -v1950M "$splitOutput" "$esdFile"
          
          if ($LASTEXITCODE -ne 0) { throw "âŒ 7z split failed (code: $LASTEXITCODE)" }

          # 3. éªŒè¯åˆ†å·æ–‡ä»¶
          $splitFiles = Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Filter "$($env:TARGET_ESD).7z.*" | Sort-Object Name
          if ($splitFiles.Count -eq 0) { throw "âŒ No split files created" }
          
          Write-Host "âœ… Split completed successfully!"
          Write-Host "ğŸ“Š Total volumes: $($splitFiles.Count)"
          foreach ($file in $splitFiles) {
              $fileSize = [math]::Round($file.Length/1GB,2)
              Write-Host " - $($file.Name): $fileSize GB"
          }

          # 4. åˆ é™¤æºESD (èŠ‚çœç©ºé—´)
          Write-Host "ğŸ§¹ Deleting source ESD file..."
          Remove-Item -Path $esdFile -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… ESD file deleted"

      # ========== ä¸Šä¼ åˆ†å·æ–‡ä»¶åˆ°Artifact (å¤‡ç”¨) ==========
      - name: Upload Split Volumes
        uses: actions/upload-artifact@v4
        with:
          name: windows7-split-volumes
          path: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          retention-days: 90
        run: |
          Write-Host "`nğŸ“¤ Uploading split volumes to Artifact..."
          $splitFiles = Get-ChildItem -Path "${{ github.workspace }}" -Filter "${{ env.TARGET_ESD }}.7z.*"
          Write-Host "âœ… $($splitFiles.Count) volumes to upload"

  # Job4: å‘å¸ƒåˆ°GitHub Releases (ä¾èµ–Job3ï¼ŒæŒ‡å®šTag/Name)
  publish-release:
    needs: split-esd
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Split Volumes
        uses: actions/download-artifact@v4
        with:
          name: windows7-split-volumes
          path: ${{ github.workspace }}
        run: |
          Write-Host "ğŸ“¥ Downloading split volumes..."
          $splitFiles = Get-ChildItem -Path "${{ github.workspace }}" -Filter "${{ env.TARGET_ESD }}.7z.*"
          if ($splitFiles.Count -eq 0) { throw "âŒ Split volumes not found" }
          Write-Host "âœ… $($splitFiles.Count) volumes downloaded"

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          files: ${{ github.workspace }}/${{ env.TARGET_ESD }}.7z.*
          draft: false
          prerelease: false
          body: |
            # Windows7_ULT&ENT_32&64
            - Compressed ESD split into 1950M volumes
            - Included images:
              - Windows7x86ULTIMATE (Index 5)
              - Windows7x86ENTERPRISE (Index 1)
              - Windows7x64ULTIMATE (Index 4)
              - Windows7x64ENTERPRISE (Index 1)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========== æœ€ç»ˆæ¸…ç† ==========
      - name: Final Cleanup
        if: always()
        shell: powershell
        run: |
          Write-Host "ğŸ§¹ Final cleanup..."
          $tempDirs = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "temp_*" -Directory
          foreach ($dir in $tempDirs) {
              Remove-Item -Path $dir.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }
          Write-Host "âœ… All temp files cleaned!"
          Write-Host "ğŸ‰ Workflow completed successfully!"
