  name:Windows7_ULT&ENT_32&64_ESD

# 触发方式：手动触发（推荐），也可添加push/定时触发
on:
  workflow_dispatch:

# 工作流权限（上传Releases需要写权限）
permissions:
  contents: write

# 作业定义
jobs:
  build-win7-esd:
    # 使用Windows最新版Runner（必须，DISM是Windows自带工具）
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh # 使用PowerShell Core执行命令

    steps:
      # 步骤1：检出仓库（为了后续上传Releases时关联仓库）
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：创建工作目录（避免文件混乱）
      - name: Create Working Directory
        run: |
          New-Item -Path ./win7-build -ItemType Directory -Force
          Set-Location ./win7-build
          Write-Host "当前工作目录：$(Get-Location)"

      # -------------------------- 第一步：处理x86 ULT版本 --------------------------
      - name: Download Windows7x86ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          # 定义下载链接列表
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003"
          )
          # 批量下载（带重试）
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            Write-Host "正在下载：$filename"
            Invoke-WebRequest -Uri $url -OutFile $filename -RetryCount 3 -RetryIntervalSec 5
          }

      - name: 解压Windows7x86ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          # 7z解压分卷（只需解压第一个分卷，自动识别后续）
          7z x -y install_Windows7x86ULTIMATE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 提取x86 ULT第5个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          # DISM提取镜像（首次创建WIN7.wim）
          dism /export-image `
            /SourceImageFile:install_Windows7x86ULTIMATE.wim `
            /SourceIndex:5 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          # 删除原WIM文件
          Remove-Item -Path install_Windows7x86ULTIMATE.wim -Force
          Write-Host "x86 ULT处理完成，WIN7.wim已创建"

      # -------------------------- 第二步：处理x86 ENT版本 --------------------------
      - name: Download Windows7x86ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002"
          )
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            Write-Host "正在下载：$filename"
            Invoke-WebRequest -Uri $url -OutFile $filename -RetryCount 3 -RetryIntervalSec 5
          }

      - name: 解压Windows7x86ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x86ENTERPRISE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 追加x86 ENT第1个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x86ENTERPRISE.wim `
            /SourceIndex:1 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x86ENTERPRISE.wim -Force
          Write-Host "x86 ENT处理完成，已追加到WIN7.wim"

      # -------------------------- 第三步：处理x64 ULT版本 --------------------------
      - name: Download Windows7x64ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003"
          )
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            Write-Host "正在下载：$filename"
            Invoke-WebRequest -Uri $url -OutFile $filename -RetryCount 3 -RetryIntervalSec 5
          }

      - name: 解压Windows7x64ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x64ULTIMATE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 追加x64 ULT第4个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x64ULTIMATE.wim `
            /SourceIndex:4 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x64ULTIMATE.wim -Force
          Write-Host "x64 ULT处理完成，已追加到WIN7.wim"

      # -------------------------- 第四步：处理x64 ENT版本 --------------------------
      - name: Download Windows7x64ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003"
          )
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            Write-Host "正在下载：$filename"
            Invoke-WebRequest -Uri $url -OutFile $filename -RetryCount 3 -RetryIntervalSec 5
          }

      - name: 解压Windows7x64ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x64ENTERPRISE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 追加x64 ENT第1个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x64ENTERPRISE.wim `
            /SourceIndex:1 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x64ENTERPRISE.wim -Force
          Write-Host "x64 ENT处理完成，已追加到WIN7.wim"

      # -------------------------- 第五步：WIM转ESD --------------------------
      - name: 转换WIN7.wim为WIN7.esd（Recovery压缩）
        run: |
          Set-Location ./win7-build
          # ESD使用recovery压缩（最高压缩比，符合微软ESD标准）
          dism /export-image `
            /SourceImageFile:WIN7.wim `
            /SourceIndex:1 `
            /DestinationImageFile:WIN7.esd `
            /Compress:recovery `
            /CheckIntegrity `
            /Format:ESD
          # 验证ESD文件
          if (Test-Path ./WIN7.esd) {
            Write-Host "ESD转换完成，文件大小：$(Get-Item ./WIN7.esd).Length / 1GB) GB"
          } else {
            throw "ESD转换失败，未找到WIN7.esd文件"
          }

      # -------------------------- 第六步：1950M分卷压缩 --------------------------
      - name: 分卷压缩WIN7.esd（1950M/卷）
        run: |
          Set-Location ./win7-build
          # 7z分卷压缩：-v1950M 指定分卷大小，-t7z 7z格式，-mx9 最高压缩
          7z a -t7z -mx9 -v1950M WIN7.7z WIN7.esd
          Write-Host "分卷压缩完成，生成文件：$(Get-ChildItem WIN7.7z.*)"

      # -------------------------- 第七步：上传到Releases --------------------------
      - name: 上传分卷到Releases
        uses: softprops/action-gh-release@v2
        with:
          # Releases标签（唯一标识）
          tag_name: Windows7_ULT&ENT_32&64_$(Get-Date -Format "yyyyMMddHHmm")
          # Releases标题
          name: Windows7_ULT&ENT_32&64
          # 上传的文件（所有分卷）
          files: ./win7-build/WIN7.7z.*
          # 是否为预发布（可选）
          prerelease: false
        env:
          # GitHub Token（默认GITHUB_TOKEN有写权限）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 可选：清理工作目录（节省空间）
      - name: 清理临时文件
        if: always() # 无论前面步骤是否失败都执行
        run: |
          Remove-Item -Path ./win7-build -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "临时文件清理完成"
