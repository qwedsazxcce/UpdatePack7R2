name: Windows7

# 触发方式：手动触发
on:
  workflow_dispatch:

# 工作流权限（上传Releases需要写权限）
permissions:
  contents: write

# 作业定义
jobs:
  build-win7-esd:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh # 使用PowerShell Core执行命令

    steps:
      # 步骤1：检出仓库
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 步骤2：创建工作目录
      - name: Create Working Directory
        run: |
          New-Item -Path ./win7-build -ItemType Directory -Force
          Set-Location ./win7-build
          Write-Host "当前工作目录：$(Get-Location)"

      # -------------------------- 第一步：处理x86 ULT版本 --------------------------
      - name: Download Windows7x86ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          # 定义下载链接列表
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003"
          )
          
          # 手动实现重试逻辑（原生PowerShell支持）
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            $retryCount = 0
            $maxRetries = 3
            $retryDelay = 5 # 重试间隔（秒）
            $success = $false
            
            while ($retryCount -lt $maxRetries -and -not $success) {
              try {
                Write-Host "正在下载（第$($retryCount+1)次尝试）：$filename"
                # 原生Invoke-WebRequest，移除不兼容参数
                Invoke-WebRequest -Uri $url -OutFile $filename -UseBasicParsing -ErrorAction Stop
                $success = $true
                Write-Host "$filename 下载成功"
              }
              catch {
                $retryCount++
                Write-Warning "$filename 下载失败，$retryDelay 秒后重试（剩余重试次数：$($maxRetries - $retryCount)）"
                Start-Sleep -Seconds $retryDelay
              }
            }
            
            if (-not $success) {
              throw "$filename 多次下载失败，终止工作流"
            }
          }

      - name: 解压Windows7x86ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x86ULTIMATE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 提取x86 ULT第5个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x86ULTIMATE.wim `
            /SourceIndex:5 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x86ULTIMATE.wim -Force
          Write-Host "x86 ULT处理完成，WIN7.wim已创建"

      # -------------------------- 第二步：处理x86 ENT版本 --------------------------
      - name: Download Windows7x86ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002"
          )
          
          # 手动重试逻辑
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            $retryCount = 0
            $maxRetries = 3
            $retryDelay = 5
            $success = $false
            
            while ($retryCount -lt $maxRetries -and -not $success) {
              try {
                Write-Host "正在下载（第$($retryCount+1)次尝试）：$filename"
                Invoke-WebRequest -Uri $url -OutFile $filename -UseBasicParsing -ErrorAction Stop
                $success = $true
                Write-Host "$filename 下载成功"
              }
              catch {
                $retryCount++
                Write-Warning "$filename 下载失败，$retryDelay 秒后重试（剩余重试次数：$($maxRetries - $retryCount)）"
                Start-Sleep -Seconds $retryDelay
              }
            }
            
            if (-not $success) {
              throw "$filename 多次下载失败，终止工作流"
            }
          }

      - name: 解压Windows7x86ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x86ENTERPRISE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 追加x86 ENT第1个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x86ENTERPRISE.wim `
            /SourceIndex:1 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x86ENTERPRISE.wim -Force
          Write-Host "x86 ENT处理完成，已追加到WIN7.wim"

      # -------------------------- 第三步：处理x64 ULT版本 --------------------------
      - name: Download Windows7x64ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003"
          )
          
          # 手动重试逻辑
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            $retryCount = 0
            $maxRetries = 3
            $retryDelay = 5
            $success = $false
            
            while ($retryCount -lt $maxRetries -and -not $success) {
              try {
                Write-Host "正在下载（第$($retryCount+1)次尝试）：$filename"
                Invoke-WebRequest -Uri $url -OutFile $filename -UseBasicParsing -ErrorAction Stop
                $success = $true
                Write-Host "$filename 下载成功"
              }
              catch {
                $retryCount++
                Write-Warning "$filename 下载失败，$retryDelay 秒后重试（剩余重试次数：$($maxRetries - $retryCount)）"
                Start-Sleep -Seconds $retryDelay
              }
            }
            
            if (-not $success) {
              throw "$filename 多次下载失败，终止工作流"
            }
          }

      - name: 解压Windows7x64ULTIMATE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x64ULTIMATE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 追加x64 ULT第4个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x64ULTIMATE.wim `
            /SourceIndex:4 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x64ULTIMATE.wim -Force
          Write-Host "x64 ULT处理完成，已追加到WIN7.wim"

      # -------------------------- 第四步：处理x64 ENT版本 --------------------------
      - name: Download Windows7x64ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          $urls = @(
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002",
            "https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003"
          )
          
          # 手动重试逻辑
          foreach ($url in $urls) {
            $filename = $url.Split('/')[-1]
            $retryCount = 0
            $maxRetries = 3
            $retryDelay = 5
            $success = $false
            
            while ($retryCount -lt $maxRetries -and -not $success) {
              try {
                Write-Host "正在下载（第$($retryCount+1)次尝试）：$filename"
                Invoke-WebRequest -Uri $url -OutFile $filename -UseBasicParsing -ErrorAction Stop
                $success = $true
                Write-Host "$filename 下载成功"
              }
              catch {
                $retryCount++
                Write-Warning "$filename 下载失败，$retryDelay 秒后重试（剩余重试次数：$($maxRetries - $retryCount)）"
              }
            }
            
            if (-not $success) {
              throw "$filename 多次下载失败，终止工作流"
            }
          }

      - name: 解压Windows7x64ENTERPRISE 7z分卷
        run: |
          Set-Location ./win7-build
          7z x -y install_Windows7x64ENTERPRISE-26.1.15.7z.001
          Write-Host "解压完成，当前文件：$(Get-ChildItem)"

      - name: 追加x64 ENT第1个镜像到WIN7.wim
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:install_Windows7x64ENTERPRISE.wim `
            /SourceIndex:1 `
            /DestinationImageFile:WIN7.wim `
            /Compress:max `
            /CheckIntegrity
          Remove-Item -Path install_Windows7x64ENTERPRISE.wim -Force
          Write-Host "x64 ENT处理完成，已追加到WIN7.wim"

      # -------------------------- 第五步：WIM转ESD --------------------------
      - name: 转换WIN7.wim为WIN7.esd（Recovery压缩）
        run: |
          Set-Location ./win7-build
          dism /export-image `
            /SourceImageFile:WIN7.wim `
            /SourceIndex:1 `
            /DestinationImageFile:WIN7.esd `
            /Compress:recovery `
            /CheckIntegrity `
            /Format:ESD
          if (Test-Path ./WIN7.esd) {
            Write-Host "ESD转换完成，文件大小：$([math]::Round((Get-Item ./WIN7.esd).Length / 1GB, 2)) GB"
          } else {
            throw "ESD转换失败，未找到WIN7.esd文件"
          }

      # -------------------------- 第六步：1950M分卷压缩 --------------------------
      - name: 分卷压缩WIN7.esd（1950M/卷）
        run: |
          Set-Location ./win7-build
          7z a -t7z -mx9 -v1950M WIN7.7z WIN7.esd
          Write-Host "分卷压缩完成，生成文件：$(Get-ChildItem WIN7.7z.* | Select-Object -ExpandProperty Name)"

      # -------------------------- 第七步：上传到Releases --------------------------
      - name: 上传分卷到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Windows7_ULT&ENT_32&64_$(Get-Date -Format "yyyyMMddHHmm")
          name: Windows7_ULT&ENT_32&64
          files: ./win7-build/WIN7.7z.*
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 清理临时文件
      - name: 清理临时文件
        if: always()
        run: |
          Remove-Item -Path ./win7-build -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "临时文件清理完成"
