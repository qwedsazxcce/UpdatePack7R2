name: Windows_7_ULT&ENT_32&64
on:
  push:
    branches: ["main"]
    paths:
      - '.github/workflows/Windows_7_ULT&ENT_32&64.yml'

jobs:
  build-and-upload-esd:
    runs-on: windows-latest
    env:
      # ========== 下载地址变量 ==========
      install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
      install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
      install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
      install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
      install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
      install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
      install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
      install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
      install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
      install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
      install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
      install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
      # ========== 通用配置（新增工作目录变量） ==========
      WORK_DIR: ${{ github.workspace }}  # GitHub Actions默认工作目录（有完全权限）
      ESD_MAIN_FILE: "Windows_7_ULT&ENT_32&64.esd"
      SPLIT_SIZE: "1950M"
      RETRY_COUNT: 10
      RETRY_INTERVAL: 30
      RELEASE_NAME: "Windows_7_ULT&ENT_32&64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========== 步骤1：循环处理每个版本（核心修复权限+路径） ==========
      - name: Process each Windows 7 version
        shell: pwsh
        run: |
          $versions = @(
            @{ Prefix = "install_Windows7x86ULTIMATE"; Index = 5 },
            @{ Prefix = "install_Windows7x86ENTERPRISE"; Index = 1 },
            @{ Prefix = "install_Windows7x64ULTIMATE"; Index = 4 },
            @{ Prefix = "install_Windows7x64ENTERPRISE"; Index = 1 }
          )
          
          foreach ($version in $versions) {
            $prefix = $version.Prefix
            $index = $version.Index
            Write-Host "===== 开始处理版本：$prefix ====="

            # ---------- 子步骤1.1：下载分卷+校验 ----------
            Write-Host "下载并校验 $prefix 分卷"
            $volumes = @("001", "002", "003")
            foreach ($vol in $volumes) {
              $varName = "$prefix`_$vol"
              $url = [Environment]::GetEnvironmentVariable($varName)
              if (-not $url) {
                Write-Warning "变量 $varName 未定义，跳过该分卷"
                continue
              }
              # 分卷文件名保持和URL一致（避免7z识别错误）
              $fileName = "$prefix-$vol.7z"
              $filePath = Join-Path -Path $env:WORK_DIR -ChildPath $fileName
              # 下载（强制覆盖+校验）
              curl.exe -L -f -sS -o "$filePath" "$url"
              if ($LASTEXITCODE -ne 0) {
                throw "下载 $fileName 失败，退出码：$LASTEXITCODE"
              }
              # 校验文件大小
              $fileSize = (Get-Item "$filePath").Length
              if ($fileSize -eq 0) {
                throw "$fileName 下载后为空文件（大小0字节）"
              }
              Write-Host "$fileName 下载成功（大小：$([math]::Round($fileSize/1MB,2)) MB）"
            }

            # ---------- 子步骤1.2：修复核心：指定有权限的解压目录+提前创建 ----------
            Write-Host "创建解压目录（工作目录内，避免权限问题）"
            # 1. 定义绝对解压路径（在GitHub工作目录下，有完全权限）
            $extractDir = Join-Path -Path $env:WORK_DIR -ChildPath "extract_$prefix"
            # 2. 提前创建目录（避免7z自动创建时权限不足）
            if (Test-Path $extractDir) {
              Remove-Item -Path $extractDir -Recurse -Force
            }
            New-Item -ItemType Directory -Path $extractDir -Force | Out-Null
            Write-Host "解压目录：$extractDir（权限已确认）"

            # 3. 解压分卷（用001文件作为入口，指定绝对路径）
            $firstVol = Join-Path -Path $env:WORK_DIR -ChildPath "$prefix-001.7z"
            Write-Host "开始解压分卷：$firstVol"
            # 7z命令：-o后直接跟绝对路径（无空格），-bb1输出基础日志
            7z x -y -bb1 -o"$extractDir" "$firstVol"
            if ($LASTEXITCODE -ge 2) {
              throw "解压 $prefix 失败，7z退出码：$LASTEXITCODE"
            }

            # ---------- 子步骤1.3：查找WIM文件 ----------
            Write-Host "查找WIM文件"
            $wimFiles = Get-ChildItem -Path $extractDir -Filter "*.wim" -Recurse
            if ($wimFiles.Count -eq 0) {
              throw "在 $extractDir 中未找到WIM文件"
            }
            $wimPath = "`"$($wimFiles[0].FullName)`""
            Write-Host "找到WIM文件：$($wimFiles[0].FullName)"

            # ---------- 子步骤1.4：CMD转换WIM到ESD ----------
            Write-Host "转换WIM到ESD（索引：$index）"
            $esdPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:ESD_MAIN_FILE
            $esdPathQuote = "`"$esdPath`""
            $dismCmd = "dism /export-image /sourceimagefile=$wimPath /sourceindex=$index /destinationimagefile=$esdPathQuote /compress:recovery /checkintegrity"
            Write-Host "执行DISM命令：$dismCmd"
            cmd /c $dismCmd
            if ($LASTEXITCODE -ne 0) {
              throw "DISM转换失败，退出码：$LASTEXITCODE"
            }

            # ---------- 子步骤1.5：清理临时文件 ----------
            Write-Host "清理 $prefix 临时文件"
            # 删除分卷文件
            foreach ($vol in $volumes) {
              $fileName = "$prefix-$vol.7z"
              $filePath = Join-Path -Path $env:WORK_DIR -ChildPath $fileName
              if (Test-Path $filePath) {
                Remove-Item -Path $filePath -Force
              }
            }
            # 删除解压目录
            if (Test-Path $extractDir) {
              Remove-Item -Path $extractDir -Recurse -Force
            }

            Write-Host "===== 完成处理版本：$prefix ====="
          }

      # ========== 步骤2：分卷压缩最终ESD文件 ==========
      - name: Split compress ESD file
        shell: pwsh
        run: |
          Write-Host "分卷压缩 ESD 文件"
          $esdPath = Join-Path -Path $env:WORK_DIR -ChildPath $env:ESD_MAIN_FILE
          $splitOutput = Join-Path -Path $env:WORK_DIR -ChildPath "$($env:ESD_MAIN_FILE).7z"
          # 分卷压缩（指定工作目录，避免权限问题）
          7z a -y -v$($env:SPLIT_SIZE) "$splitOutput" "$esdPath"
          if ($LASTEXITCODE -ge 2) {
            throw "7z分卷压缩失败，退出码：$LASTEXITCODE"
          }
          # 删除原始ESD
          Remove-Item -Path $esdPath -Force

      # ========== 步骤3：GH CLI上传（删除旧版本+重试） ==========
      - name: Upload via GitHub CLI with retry
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $releaseName = $env:RELEASE_NAME
          $splitFiles = Get-ChildItem -Path "$env:WORK_DIR\$($env:ESD_MAIN_FILE).7z.*" -ErrorAction Stop
          $retryCount = [int]$env:RETRY_COUNT
          $retryInterval = [int]$env:RETRY_INTERVAL

          # 删除旧Release/Tag
          Write-Host "删除原有Release/Tag：$releaseName"
          gh release delete "$releaseName" -y 2>&1 | Out-Null
          git tag -d "$releaseName" 2>&1 | Out-Null
          git push origin --delete "$releaseName" 2>&1 | Out-Null

          # 上传重试逻辑
          $uploadSuccess = $false
          for ($i=1; $i -le $retryCount; $i++) {
            try {
              Write-Host "第 $i 次上传（共 $retryCount 次）"
              # 创建新Release
              gh release create "$releaseName" --title "$releaseName" --notes "Auto-built Windows 7 ESD"
              # 上传所有分卷
              foreach ($file in $splitFiles) {
                gh release upload "$releaseName" "`"$($file.FullName)`"" --clobber
              }
              $uploadSuccess = $true
              Write-Host "上传成功"
              break
            }
            catch {
              Write-Warning "第 $i 次上传失败：$($_.Exception.Message)"
              if ($i -lt $retryCount) {
                Write-Host "等待 $retryInterval 秒后重试..."
                Start-Sleep -Seconds $retryInterval
              }
            }
          }

          if (-not $uploadSuccess) {
            throw "重试 $retryCount 次后仍上传失败"
          }

      # ========== 步骤4：最终兜底清理 ==========
      - name: Final cleanup
        shell: pwsh
        if: always()
        run: |
          Write-Host "执行最终清理"
          # 删除临时解压目录
          Get-ChildItem -Path $env:WORK_DIR -Filter "extract_*" -Directory | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          # 删除残留分卷源文件
          Get-ChildItem -Path $env:WORK_DIR -Filter "install_Windows7*.7z.00*" | Remove-Item -Force -ErrorAction SilentlyContinue
          Write-Host "清理完成"
