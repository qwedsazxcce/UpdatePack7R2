name: Windows_7_ULT&ENT_32&64
on:
  push:
    branches: ["main"]  # 提交任意分支代码都触发工作流
    paths:
      - '.github/workflows//Windows_7_ULT.ENT_32.64.yml'  # 仅修改这个工作流文件时触发
      # 可选：如果有其他需要触发的文件（如版本配置文件），可追加
      # - 'config/windows7-download-urls.yml'
jobs:
  build-and-upload-esd:
    runs-on: windows-latest
    env:
      # ========== 下载地址变量（可直接修改） ==========
      install_Windows7x86ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.001
      install_Windows7x86ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.002
      install_Windows7x86ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ULTIMATE-26.1.15/install_Windows7x86ULTIMATE-26.1.15.7z.003
      install_Windows7x86ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.001
      install_Windows7x86ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x86ENTERPRISE-26.1.15/install_Windows7x86ENTERPRISE-26.1.15.7z.002
      install_Windows7x86ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/Misc/test.txt
      install_Windows7x64ULTIMATE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.001
      install_Windows7x64ULTIMATE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.002
      install_Windows7x64ULTIMATE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ULTIMATE-26.1.15/install_Windows7x64ULTIMATE-26.1.15.7z.003
      install_Windows7x64ENTERPRISE_001: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.001
      install_Windows7x64ENTERPRISE_002: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.002
      install_Windows7x64ENTERPRISE_003: https://github.com/qwedsazxcce/UpdatePack7R2/releases/download/install_Windows7x64ENTERPRISE-26.1.15/install_Windows7x64ENTERPRISE-26.1.15.7z.003
      # ========== 通用配置变量 ==========
      ESD_MAIN_FILE: "Windows_7_ULT&ENT_32&64.esd"  # 最终ESD文件名
      SPLIT_SIZE: "1950M"                            # 分卷压缩大小
      RETRY_COUNT: 10                                # 上传重试次数
      RETRY_INTERVAL: 30                             # 重试间隔（秒）
      RELEASE_NAME: "Windows_7_ULT&ENT_32&64"        # 发布名称/标签名

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========== 步骤1：定义处理版本的列表（循环用） ==========
      - name: Define version processing list
        id: define_versions
        shell: pwsh
        run: |
          # 定义需要处理的版本：名称前缀、转换索引
          $versions = @(
            @{ Prefix = "install_Windows7x86ULTIMATE"; Index = 5 },
            @{ Prefix = "install_Windows7x86ENTERPRISE"; Index = 1 },
            @{ Prefix = "install_Windows7x64ULTIMATE"; Index = 4 },
            @{ Prefix = "install_Windows7x64ENTERPRISE"; Index = 1 }
          )
          # 转换为JSON传递给后续步骤（避免PowerShell变量跨步骤丢失）
          $versionsJson = $versions | ConvertTo-Json -Compress
          echo "versions_json=$versionsJson" >> $env:GITHUB_OUTPUT

      # ========== 步骤2：循环处理每个版本（下载→解压→转换→清理） ==========
      - name: Process each Windows 7 version
        shell: pwsh
        run: |
          # 读取版本列表
          $versions = ${{ steps.define_versions.outputs.versions_json }} | ConvertFrom-Json
          
          foreach ($version in $versions) {
            $prefix = $version.Prefix
            $index = $version.Index
            Write-Host "===== 开始处理版本：$prefix (索引：$index) ====="

            # ---------- 子步骤2.1：下载分卷压缩包 ----------
            Write-Host "下载 $prefix 分卷压缩包"
            # 获取所有分卷变量（001/002/003）
            $volumes = @("001", "002", "003")
            foreach ($vol in $volumes) {
              $varName = "$prefix`_$vol"
              $url = [Environment]::GetEnvironmentVariable($varName)
              if (-not $url) {
                Write-Warning "变量 $varName 未定义，跳过该分卷"
                continue
              }
              $fileName = "$prefix.$vol"
              # curl下载（加双引号处理特殊符号，使用系统默认curl）
              curl.exe -L -o "$fileName" "$url"
              if ($LASTEXITCODE -ne 0) {
                throw "下载 $fileName 失败，退出码：$LASTEXITCODE"
              }
            }

            # ---------- 子步骤2.2：合并并解压7z分卷 ----------
            Write-Host "解压 $prefix 分卷压缩包"
            # 7z解压分卷（环境默认7z，用双引号包裹路径/文件名）
            7z x -y "$prefix.001" -o"$prefix_temp"
            if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne 1) {  # 7z解压警告码1可忽略
              throw "解压 $prefix 失败，退出码：$LASTEXITCODE"
            }

            # ---------- 子步骤2.3：获取WIM文件名 ----------
            Write-Host "查找 $prefix 的WIM文件"
            $wimFile = Get-ChildItem -Path "$prefix_temp" -Filter "*.wim" -Recurse | Select-Object -First 1
            if (-not $wimFile) {
              throw "在 $prefix_temp 中未找到WIM文件"
            }
            $wimPath = "`"$($wimFile.FullName)`""  # 加双引号处理特殊路径

            # ---------- 子步骤2.4：调用CMD转换WIM到ESD（解决编码问题） ----------
            Write-Host "转换 $prefix WIM到ESD（索引：$index）"
            $esdPath = "`"$($env:ESD_MAIN_FILE)`""
            # 拼接CMD命令（DISM转换，追加模式）
            $dismCmd = "dism /export-image /sourceimagefile=$wimPath /sourceindex=$index /destinationimagefile=$esdPath /compress:recovery /checkintegrity"
            # 调用CMD执行（避免PowerShell编码问题）
            cmd /c $dismCmd
            if ($LASTEXITCODE -ne 0) {
              throw "DISM转换失败，退出码：$LASTEXITCODE"
            }

            # ---------- 子步骤2.5：清理临时文件 ----------
            Write-Host "清理 $prefix 临时文件"
            # 删除分卷压缩包
            foreach ($vol in $volumes) {
              $fileName = "$prefix.$vol"
              if (Test-Path "$fileName") {
                Remove-Item -Path "$fileName" -Force
              }
            }
            # 删除解压目录和WIM文件
            if (Test-Path "$prefix_temp") {
              Remove-Item -Path "$prefix_temp" -Recurse -Force
            }

            Write-Host "===== 完成处理版本：$prefix ====="
          }

      # ========== 步骤3：分卷压缩最终ESD文件 ==========
      - name: Split compress ESD file
        shell: pwsh
        run: |
          Write-Host "分卷压缩 $($env:ESD_MAIN_FILE)（大小：$($env:SPLIT_SIZE)）"
          # 7z分卷压缩（同名分卷，环境默认7z）
          7z a -y -v$($env:SPLIT_SIZE) "`"$($env:ESD_MAIN_FILE).7z`"" "`"$($env:ESD_MAIN_FILE)`""
          if ($LASTEXITCODE -ne 0) {
            throw "分卷压缩失败，退出码：$LASTEXITCODE"
          }
          # 删除原始ESD文件（保留分卷）
          Remove-Item -Path "`"$($env:ESD_MAIN_FILE)`"" -Force

      # ========== 步骤4：gh cli上传（删除旧版本+重试逻辑） ==========
      - name: Upload via GitHub CLI with retry
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}  # 工作流默认认证token
        run: |
          $releaseName = $env:RELEASE_NAME
          $splitFiles = Get-ChildItem -Path "`"$($env:ESD_MAIN_FILE).7z.*`""
          $retryCount = $env:RETRY_COUNT -as [int]
          $retryInterval = $env:RETRY_INTERVAL -as [int]

          # ---------- 子步骤4.1：删除原有Release和Tag ----------
          Write-Host "删除原有Release和Tag：$releaseName"
          # 先删除Release（忽略不存在的错误）
          gh release delete "$releaseName" -y 2>&1 | Out-Null
          # 再删除Tag（忽略不存在的错误）
          git tag -d "$releaseName" 2>&1 | Out-Null
          git push origin --delete "$releaseName" 2>&1 | Out-Null

          # ---------- 子步骤4.2：上传分卷文件（带重试） ----------
          $uploadSuccess = $false
          for ($i=1; $i -le $retryCount; $i++) {
            try {
              Write-Host "第 $i 次尝试上传文件（共 $retryCount 次）"
              # 创建新Release（带Tag）
              gh release create "$releaseName" --title "$releaseName" --notes "Auto-built Windows 7 ESD"
              # 上传所有分卷文件
              foreach ($file in $splitFiles) {
                gh release upload "$releaseName" "`"$($file.FullName)`"" --clobber
              }
              $uploadSuccess = $true
              Write-Host "上传成功！"
              break
            }
            catch {
              Write-Warning "第 $i 次上传失败：$_"
              if ($i -lt $retryCount) {
                Write-Host "等待 $retryInterval 秒后重试..."
                Start-Sleep -Seconds $retryInterval
              }
            }
          }

          if (-not $uploadSuccess) {
            throw "重试 $retryCount 次后仍上传失败"
          }

      # ========== 步骤5：清理所有临时文件（最终兜底） ==========
      - name: Final cleanup
        shell: pwsh
        if: always()  # 无论前面步骤是否失败，都执行清理
        run: |
          Write-Host "执行最终清理"
          # 删除所有临时目录
          Get-ChildItem -Path . -Filter "*_temp" -Directory | Remove-Item -Recurse -Force
          # 删除所有7z分卷源文件（若有残留）
          Get-ChildItem -Path . -Filter "install_Windows7*.00*" | Remove-Item -Force
          Write-Host "清理完成"
